# 小说生成漫画应用 开发指南（新手友好）

本文面向开发新手，结合 PRD 与 README，给出从环境搭建到功能开发的顺序、项目结构与注意事项。按本文逐步执行，可在 3–7 天完成 MVP。

## 一、开发顺序（分阶段）
1) 环境搭建与跑通“空框架”
- 安装：Windows 10/11、Python 3.10+、Flutter 3.22+、Visual Studio（含“Desktop development with C++”）。
- 检查 Flutter 桌面：`flutter config --enable-windows-desktop`、`flutter doctor`
- 后端本地服务：创建虚拟环境与依赖，启动 FastAPI（见下文）。
- 前端跑起来：`flutter create app && flutter run -d windows`（后续替换为你的正式客户端工程）。

2) 后端 MVP（FastAPI）
- 实现最小接口：
  - `POST /novel/upload`（上传文本并返回项目/章节结构）
  - `POST /pipeline/start`（根据章节触发生成流程，先返回假数据）
  - `GET /job/{id}`（查询生成进度，先用模拟进度）
  - `GET /assets/{id}`（返回占位图片/文档）
- 本地存储与目录：`data/`、`outputs/` 建好，读写权限确认。

3) 前端 MVP（Flutter 桌面）
- 页面骨架：三栏布局（小说列表｜章节列表｜内容 + 生成按钮）。
- 文件导入：支持 `.txt`（先不做 PDF/Word），读入内存或保存至本地。
- 生成流程：点击“生成漫画”→显示分镜占位数据→导出 PNG（占位图）。

4) 文本解析与章节拆分
- `.txt` 编码兼容（UTF-8/GBK），统一转 UTF-8。
- 章节识别：正则匹配“第…章/节”等，允许用户手动校正。

5) 分镜脚本与图像生成（云 API）
- LLM 调用：根据章节内容生成 3–8 个分镜描述与台词（固定模板）。
- 图像生成：先用占位图/本地素材；再接入云图像 API（SDXL/FLUX）。

6) 排版与导出
- 版式模板：竖版条漫（3–4 格/页）先完成；后续补横版、方形四格。
- 导出：PNG/JPG、PDF、CBZ（MVP 至少支持 PNG + PDF）。
- 长图拼接（可选）：将多张面板拼为一张竖向长图（前端或后端实现）。

7) 个人中心与素材库（增量）
- 账号与设置：本地路径设置、水印、默认导出格式。
- 历史作品库：保存生成记录与再次导出。
- 角色/场景素材：先支持小说专属角色图；后增公共模板。

## 二、项目结构（建议）
```
project/
  desktop/      # Flutter Windows 客户端
  backend/      # FastAPI 服务（编排云 API）
  configs/      # .env 等配置与密钥（仅后端读取）
  data/         # 输入与中间数据（文本、章节解析）
  outputs/      # 导出文件（图片、PDF、CBZ、视频）
  docs/         # 文档（BRD/PRD/开发指南等）
```
- 命名规范：
  - 文件与文件夹使用英文与下划线（如 `comic_export_service.py`）。
  - 资源按项目/小说/章节分层：`outputs/<novel>/<chapter>/...`。

## 三、环境与运行（一步步）
- Python 虚拟环境：
  - `python -m venv .venv && .venv\Scripts\activate`
  - `pip install fastapi uvicorn python-multipart pydantic[dotenv] pillow`
- 启动后端：
  - 代码入口示例：`uvicorn app.main:app --host 127.0.0.1 --port 8787 --reload`
- Flutter 桌面：
  - `flutter run -d windows`
- `.env`（后端读取）：
  - `LLM_PROVIDER=...`、`LLM_API_KEY=...`、`IMAGE_API_KEY=...`

## 四、后端接口（MVP 草案）
- `POST /novel/upload`
  - 入参：文本或文件；出参：小说 ID、章节列表。
- `POST /pipeline/start`
  - 入参：章节 ID、模板类型、角色配置；出参：任务 ID。
- `GET /job/{id}`
  - 出参：状态（queued/running/done/failed）、进度、错误信息。
- `GET /assets/{id}`
  - 出参：图片/文档（URL 或本地路径）。
- 可选导出：`POST /export/long_image`（竖向拼接）、`POST /export/comic_page`（模板排版）。

## 五、前端实现（关键点）
- 框架与依赖（建议）：
  - 路由：`go_router`；状态：`riverpod`/`bloc`；网络：`dio`；文件：`file_selector`。
  - 导出：`image`（图像处理）、`pdf`/`printing`（PDF）、`path_provider`（路径）。
- 三栏布局：
  - 左：小说列表（新增/设置/删除）；中：章节列表；右：章节内容 + “生成漫画”。
- 场景与遮罩：
  - 前端预览可用 `ClipPath`/`CustomClipper` 实现梯形裁剪；导出用 `RepaintBoundary.toImage()`。
- 生成流程交互：
  - 点击生成后灰屏 + 小游戏弹窗（MVP 可先用占位对话框，后续接入小游戏）。

## 六、文本解析（.txt）
- 编码：检测并转换为 UTF-8；处理换行与空行。
- 章节拆分：正则匹配常见章节标题；用户可手动合并/拆分。
- 存储策略：
  - 默认“内存解析”，生成后可选择保存到 `data/novels/` 以便复用。

## 七、导出与分享
- 导出格式：PNG/JPG（单张/批量）、PDF、CBZ；后续 MP4（连贯播放）。
- 水印：文本 + 透明度；默认账号名居中。
- 一键分享：系统层面调起微信/QQ/钉钉（MVP 可先打开输出目录）。

## 八、质量与一致性
- 角色一致性：角色参考图 + 固定 Prompt 片段；图生图/IP-Adapter。
- 构图一致性：模板网格 + ControlNet（姿态/深度/线稿）。
- 文本气泡：台词长度控制、断行策略、避免遮挡。

## 九、性能与稳定
- 云调用：并发与速率限制；处理 429/5xx 重试；缓存（哈希 key）。
- 前端：长任务使用 Isolate；懒加载章节；图片用缩略图列表。
- 内存保护：导出按页处理，不一次性加载所有大图。

## 十、测试与验收（MVP）
- 单元测试：章节拆分、长图拼接、模板排版尺寸校验。
- 集成测试：上传→解析→分镜→导出 PNG/PDF 全链路。
- 验收清单：
  - 导入 `.txt` 并能识别 3–8 个分镜。
  - 竖版模板排版正确（像素尺寸与间距）。
  - 导出 PNG/PDF 成功，含可选水印。

## 十一、注意事项（新手必读）
- 密钥安全：API Key 只放后端 `.env`；前端不存。
- 隐私与版权：仅处理授权文本；本地优先存储；导出不要含敏感内容。
- 目录权限：`data/`、`outputs/` 需可写；Windows 路径分隔符为 `\`。
- 错误处理：后端统一错误码；前端显示友好提示与重试。

## 十二、里程碑（建议 3 迭代）
- 迭代 1：跑通上传→解析→占位分镜→PNG 导出。
- 迭代 2：接入 LLM + 简版模板排版 + PDF 导出。
- 迭代 3：接入云图像生成、长图拼接、历史作品库与设置。