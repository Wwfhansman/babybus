<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´è½¬è¿ç¯ç”»ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* ç™»å½•/æ³¨å†Œç•Œé¢æ ·å¼ */
        .auth-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .auth-switch-text {
            color: #666;
            font-size: 14px;
        }

        .auth-switch-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .auth-switch-link:hover {
            color: #764ba2;
        }

        .auth-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .error-message {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #363;
            border: 1px solid #cfc;
        }

        /* æ³¨å†Œé¡µé¢å¤´åƒä¸Šä¼ æ ·å¼ */
        .avatar-upload-register {
            border: 2px dashed #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }

        /* å¤´åƒä¸Šä¼ æ ‡ç­¾æ ·å¼ */
        .avatar-upload-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
            cursor: default; /* å› ä¸ºå®é™…ç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æŒ‡é’ˆ */
        }

        .avatar-preview-register {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            background: #fff;
        }

        .avatar-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-default-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 12px;
            text-align: center;
        }

        .avatar-upload-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .small-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .avatar-upload-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        .avatar-preview-register.has-image .avatar-default-text {
            display: none;
        }

        .avatar-preview-register.has-image .avatar-preview-img {
            display: block;
        }

        /* ä¸»åº”ç”¨ç•Œé¢æ ·å¼ */
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .app-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-welcome {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* å†…å®¹åŒºåŸŸ */
        .app-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .status {
            padding: 12px 20px;
            margin: 0 0 20px 0;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connected::before {
            background: #28a745;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .disconnected::before {
            background: #dc3545;
        }

        .connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .connecting::before {
            background: #ffc107;
        }

        /* è¿æ¥æ§åˆ¶ */
        .connection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .server-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
        }

        .connect-btn, .disconnect-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .connect-btn {
            background: #28a745;
            color: white;
        }

        .connect-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .disconnect-btn {
            background: #6c757d;
            color: white;
        }

        .disconnect-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* å¯¼èˆªæ ‡ç­¾ */
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .nav-tab:hover:not(.active) {
            color: #333;
            background: rgba(0, 0, 0, 0.03);
        }

        /* æ ‡ç­¾å†…å®¹ */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content.active {
            display: block;
        }

        /* åŠŸèƒ½åŒºåŸŸ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e5e9;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }

        .title-input {
            margin-bottom: 20px;
        }

        .title-input input,
        .title-input textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .title-input input:focus,
        .title-input textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .title-input textarea {
            height: 80px;
            resize: vertical;
        }

        .novel-textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .novel-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .primary-btn, .secondary-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .secondary-btn:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .primary-btn:disabled, .secondary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* åœºæ™¯å¡ç‰‡ */
        .scene-card {
            border: 1px solid #e1e5e9;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .scene-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .scene-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        /* å›¾ç‰‡å®¹å™¨ */
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            border: 1px solid #e1e5e9;
            padding: 15px;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .image-card h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e5e9;
        }

        .log h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .log-output {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .log-time {
            color: #666;
            font-size: 0.85em;
            margin-right: 10px;
        }

        /* å†å²è®°å½• */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .history-card {
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .history-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .history-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .history-date {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .history-scenes {
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-info {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .modal-info p {
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .modal-info strong {
            color: #333;
        }

        .modal-comics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .modal-comic-card {
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
        }

        .modal-comic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .modal-comic-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .modal-comic-info {
            padding: 20px;
        }

        .modal-comic-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .modal-comic-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .modal-error {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 10px;
            margin: 20px 0;
        }

        .modal-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 20px;
                max-height: calc(95vh - 120px);
            }

            .modal-comics-grid {
                grid-template-columns: 1fr;
            }

            .modal-comic-image {
                height: 200px;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .app-content {
                padding: 20px;
            }

            .user-info {
                position: static;
                justify-content: flex-end;
                margin-top: 15px;
            }

            .connection-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .server-input {
                min-width: auto;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .image-container {
                grid-template-columns: 1fr;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* å¤´åƒç›¸å…³æ ·å¼ */
        .user-avatar-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            cursor: pointer;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .avatar-upload-tip {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .user-avatar-container:hover .avatar-upload-tip {
            opacity: 1;
        }

        /* å¤´åƒä¸Šä¼ æ¨¡æ€æ¡†æ ·å¼ */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .current-avatar, .avatar-upload-options {
            text-align: center;
        }

        .current-avatar h3, .avatar-upload-options h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e1e5e9;
            margin: 0 auto;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2f5;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8f4fd;
        }

        .upload-placeholder {
            color: #666;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .upload-preview {
            text-align: center;
        }

        .upload-preview h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .user-avatar {
                width: 40px;
                height: 40px;
            }

            .avatar-upload-tip {
                display: none;
            }

            .preview-actions, .avatar-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
        <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
        <div id="authSection">
        <div class="auth-background"></div>
        <div class="auth-container">
            <div class="auth-header">
                <h2 id="authTitle">æ¬¢è¿å›æ¥</h2>
                <p id="authSubtitle">è¯·ç™»å½•æ‚¨çš„è´¦æˆ·ç»§ç»­ä½¿ç”¨</p>
            </div>
            <form id="authForm" class="auth-form">
                <div id="registerFields" style="display: none;">
                    <div class="form-group">
                        <label for="email">é‚®ç®±åœ°å€</label>
                        <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€ï¼ˆå¯é€‰ï¼‰">
                    </div>
                </div>
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <div id="authMessage" class="auth-message hidden"></div>
                <button type="submit" id="authButton" class="auth-button">ç™»å½•</button>
            </form>
            <div class="auth-switch">
                <span class="auth-switch-text" id="authSwitchText">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                <a class="auth-switch-link" id="authSwitchLink" onclick="toggleAuthMode()">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="container hidden">
        <div class="app-header">
            <h1>å°è¯´è½¬è¿ç¯ç”»ç³»ç»Ÿ</h1>
            <p>å°†æ‚¨çš„å°è¯´æ–‡æœ¬è½¬æ¢ä¸ºç²¾ç¾çš„è¿ç¯ç”»</p>
            <div class="user-info">
                <!-- æ·»åŠ å¤´åƒæ˜¾ç¤º -->
                <div class="user-avatar-container">
                    <img id="userAvatar" src="" alt="å¤´åƒ" class="user-avatar" onclick="openAvatarModal()">
                    <div class="avatar-upload-tip">ç‚¹å‡»ä¿®æ”¹å¤´åƒ</div>
                </div>
                <span class="user-welcome">æ¬¢è¿ï¼Œ<span id="usernameDisplay"></span></span>
                <button onclick="showHistory()" class="header-button">å†å²è®°å½•</button>
                <button onclick="logout()" class="header-button">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="app-content">
            <div class="status disconnected" id="status">
                <span>æœªè¿æ¥åˆ°æœåŠ¡å™¨</span>
            </div>

            <div class="connection-controls">
                <input type="text" id="serverAddress" value="http://139.224.101.91:5000"
                       placeholder="æœåŠ¡å™¨åœ°å€" class="server-input">
                <button class="connect-btn" onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
                <button class="disconnect-btn" onclick="disconnect()">æ–­å¼€è¿æ¥</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('generate')">ç”Ÿæˆæ¼«ç”»</button>
                <button class="nav-tab" onclick="switchTab('history')">å†å²è®°å½•</button>
            </div>

            <!-- ç”Ÿæˆæ¼«ç”»æ ‡ç­¾é¡µ -->
            <div id="generateTab" class="tab-content active">
                <div class="section">
                    <h3>åˆ›ä½œæ‚¨çš„æ¼«ç”»</h3>

                    <div class="title-input">
                        <input type="text" id="comicTitle" placeholder="ä¸ºæ‚¨çš„æ¼«ç”»èµ·ä¸ªæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                        <textarea id="comicDescription" placeholder="æ·»åŠ ä¸€äº›æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <textarea id="novelText" class="novel-textarea" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„å°è¯´æ–‡æœ¬...">å°æ˜æ˜¯ä¸€ä¸ªå‹‡æ•¢çš„å°‘å¹´ã€‚ä¸€å¤©ï¼Œä»–åœ¨æ£®æ—é‡Œé‡åˆ°äº†ä¸€åªå—ä¼¤çš„å°é¹¿ã€‚å°æ˜å°å¿ƒç¿¼ç¿¼åœ°æ¥è¿‘å°é¹¿ï¼Œå‘ç°å®ƒçš„è…¿å—ä¼¤äº†ã€‚ä»–ç”¨è‡ªå·±çš„æ‰‹å¸•ä¸ºå°é¹¿åŒ…æ‰ä¼¤å£ï¼Œç„¶åå¸®åŠ©å°é¹¿æ‰¾åˆ°äº†å®ƒçš„å¦ˆå¦ˆã€‚å°é¹¿å’Œå®ƒçš„å¦ˆå¦ˆéƒ½å¾ˆæ„Ÿæ¿€å°æ˜ï¼Œä»–ä»¬æˆä¸ºäº†å¥½æœ‹å‹ã€‚</textarea>

                    <div class="action-buttons">
                        <button class="primary-btn" onclick="testFullProcess()">å®Œæ•´æµç¨‹å¤„ç†</button>
                        <button class="secondary-btn" onclick="testProcessNovel()">ä»…å¤„ç†æ–‡æœ¬</button>
                    </div>
                </div>

                <!-- æ–‡æœ¬å¤„ç†ç»“æœåŒºåŸŸ -->
                <div id="textResultSection" class="section hidden">
                    <h3>æ–‡æœ¬å¤„ç†ç»“æœ</h3>
                    <div id="textResultContent"></div>
                    <div class="action-buttons">
                        <button id="generateComicsBtn" class="primary-btn" onclick="generateComicsFromText()">ç”Ÿæˆè¿ç¯ç”»</button>
                    </div>
                </div>

                <!-- å›¾ç‰‡ç”Ÿæˆè¿›åº¦åŒºåŸŸ -->
                <div id="progressSection" class="section hidden">
                    <h3>å›¾ç‰‡ç”Ÿæˆè¿›åº¦</h3>
                    <div class="progress-text" id="progressText">å‡†å¤‡å¼€å§‹...</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="imagesResultSection" class="section hidden">
                    <h3>ç”Ÿæˆçš„è¿ç¯ç”»</h3>
                    <div id="imagesResultContent" class="image-container"></div>
                </div>
            </div>

            <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
            <div id="historyTab" class="tab-content">
                <div class="section">
                    <h3>æˆ‘çš„æ¼«ç”»å†å²</h3>
                    <div class="history-container">
                        <div id="historyLoading" style="text-align: center; padding: 40px;">
                            <div style="color: #666; font-size: 16px;">åŠ è½½ä¸­...</div>
                        </div>
                        <div id="historyContent" class="history-grid hidden"></div>
                        <div id="historyEmpty" style="text-align: center; padding: 40px;" class="hidden">
                            <div style="color: #666; font-size: 16px; margin-bottom: 20px;">
                                è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡æ¼«ç”»
                            </div>
                            <button class="primary-btn" onclick="switchTab('generate')">å»ç”Ÿæˆç¬¬ä¸€æœ¬æ¼«ç”»</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="log">
                <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                <div id="logOutput" class="log-output"></div>
            </div>
        </div>
    </div>

        <!-- å†å²è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ¼«ç”»è¯¦æƒ…</h2>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" class="modal-loading">
                    <div style="font-size: 16px; margin-bottom: 10px;">åŠ è½½ä¸­...</div>
                    <div style="color: #999; font-size: 14px;">æ­£åœ¨è·å–æ¼«ç”»è¯¦æƒ…</div>
                </div>

                <div id="modalContent" class="hidden">
                    <div class="modal-info">
                        <p><strong>å¤„ç†ID:</strong> <span id="modalProcessId"></span></p>
                        <p><strong>æ ‡é¢˜:</strong> <span id="modalComicTitle"></span></p>
                        <p><strong>æè¿°:</strong> <span id="modalComicDescription"></span></p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> <span id="modalCreatedAt"></span></p>
                        <p><strong>åœºæ™¯æ•°é‡:</strong> <span id="modalScenesCount"></span></p>
                    </div>

                    <div id="modalImagesContent">
                        <h3 style="margin-bottom: 20px; color: #333;">è¿ç¯ç”»åœºæ™¯</h3>
                        <div id="modalComicsGrid" class="modal-comics-grid"></div>
                    </div>
                </div>

                <div id="modalError" class="modal-error hidden">
                    <div style="font-size: 16px; margin-bottom: 10px;">åŠ è½½å¤±è´¥</div>
                    <div style="font-size: 14px;" id="modalErrorMessage"></div>
                    <button class="primary-btn" onclick="closeHistoryModal()" style="margin-top: 15px;">å…³é—­</button>
                </div>

                <div id="modalEmpty" class="modal-empty hidden">
                    <div style="font-size: 16px; margin-bottom: 10px;">æ²¡æœ‰æ‰¾åˆ°æ¼«ç”»è¯¦æƒ…</div>
                    <button class="primary-btn" onclick="closeHistoryModal()" style="margin-top: 15px;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¤´åƒä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="avatarModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ä¿®æ”¹å¤´åƒ</h2>
                <button class="modal-close" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avatar-upload-section">
                    <div class="current-avatar">
                        <h3>å½“å‰å¤´åƒ</h3>
                        <img id="currentAvatarDisplay" src="" alt="å½“å‰å¤´åƒ" class="avatar-preview">
                    </div>

                    <div class="avatar-upload-options">
                        <h3>ä¸Šä¼ æ–°å¤´åƒ</h3>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-placeholder">
                                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“·</div>
                                <div>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 2MB</div>
                            </div>
                            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                        </div>

                        <div class="upload-preview hidden" id="uploadPreview">
                            <h4>é¢„è§ˆ</h4>
                            <img id="avatarPreview" src="" alt="é¢„è§ˆ" class="avatar-preview">
                            <div class="preview-actions">
                                <button class="secondary-btn" onclick="cancelUpload()">å–æ¶ˆ</button>
                                <button class="primary-btn" onclick="uploadAvatar()">ç¡®è®¤ä¸Šä¼ </button>
                            </div>
                        </div>
                    </div>

                    <div class="avatar-actions">
                        <button class="secondary-btn" onclick="removeAvatar()" id="removeAvatarBtn">ç§»é™¤å¤´åƒ</button>
                        <button class="primary-btn" onclick="closeAvatarModal()">å®Œæˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScriptä»£ç ä¿æŒä¸å˜ï¼Œåªæ›´æ–°äº†ä¸ç•Œé¢äº¤äº’çš„éƒ¨åˆ†
        // ç”¨æˆ·çŠ¶æ€ç®¡ç†
        let currentUser = null;
        let sessionToken = localStorage.getItem('sessionToken');
        let isRegisterMode = false;

        // WebSocketç›¸å…³å˜é‡
        let socket = null;
        let isConnected = false;
        let currentProcessId = null;

        // å¤´åƒç›¸å…³åŠŸèƒ½
        let selectedAvatarFile = null;

        // æ³¨å†Œé¡µé¢å¤´åƒä¸Šä¼ ç›¸å…³å˜é‡
        let registerAvatarFile = null;

        // è·å–åŸºç¡€URL
        function getBaseUrl() {
            const serverAddress = document.getElementById('serverAddress').value || 'http://10.201.202.108:5000';
            return serverAddress.replace(/\/$/, '');
        }

        // ä¿®æ”¹é¡µé¢åŠ è½½å‡½æ•°ï¼Œåˆå§‹åŒ–æ³¨å†Œå¤´åƒä¸Šä¼ 
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€');
            if (sessionToken) {
                console.log('å‘ç°ä¿å­˜çš„sessionTokenï¼Œå°è¯•è‡ªåŠ¨ç™»å½•');
                verifySession();
            } else {
                console.log('æ²¡æœ‰ä¿å­˜çš„sessionTokenï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                showAuthSection();
            }

            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
        });

        // æ˜¾ç¤ºè®¤è¯ç•Œé¢
        function showAuthSection() {
            console.log('æ˜¾ç¤ºè®¤è¯ç•Œé¢');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainApp').classList.add('hidden');
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢
        function showMainApp() {
            console.log('æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢');
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');

            // ç™»å½•åè‡ªåŠ¨è¿æ¥æœåŠ¡å™¨
            setTimeout(() => {
                if (!isConnected) {
                    console.log('ç™»å½•åè‡ªåŠ¨è¿æ¥æœåŠ¡å™¨');
                    connect();
                }
            }, 500);
        }

        // åˆå§‹åŒ–æ³¨å†Œé¡µé¢å¤´åƒä¸Šä¼ 
        function initRegisterAvatarUpload() {
            const avatarInput = document.getElementById('avatarInputRegister');
            const avatarPreview = document.getElementById('avatarPreviewRegister');
            const avatarPreviewContainer = document.querySelector('.avatar-preview-register');

            avatarInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleRegisterAvatarSelect(e.target.files[0]);
                }
            });

            // è®¾ç½®é»˜è®¤å¤´åƒé¢„è§ˆ
            avatarPreview.src = `${getBaseUrl()}/api/avatar/default.png`;
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const authButton = document.getElementById('authButton');
            const authSwitchText = document.getElementById('authSwitchText');
            const authSwitchLink = document.getElementById('authSwitchLink');
            const registerFields = document.getElementById('registerFields');
            const authMessage = document.getElementById('authMessage');

            // æ¸…é™¤æ¶ˆæ¯
            authMessage.classList.add('hidden');
            authMessage.textContent = '';
            authMessage.className = 'auth-message hidden';

            if (isRegisterMode) {
                authTitle.textContent = 'åˆ›å»ºè´¦æˆ·';
                authSubtitle.textContent = 'æ³¨å†Œæ–°è´¦æˆ·å¼€å§‹ä½¿ç”¨';
                authButton.textContent = 'æ³¨å†Œ';
                authSwitchText.textContent = 'å·²æœ‰è´¦å·ï¼Ÿ';
                authSwitchLink.textContent = 'ç«‹å³ç™»å½•';
                registerFields.style.display = 'block';
            } else {
                authTitle.textContent = 'æ¬¢è¿å›æ¥';
                authSubtitle.textContent = 'è¯·ç™»å½•æ‚¨çš„è´¦æˆ·ç»§ç»­ä½¿ç”¨';
                authButton.textContent = 'ç™»å½•';
                authSwitchText.textContent = 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ';
                authSwitchLink.textContent = 'ç«‹å³æ³¨å†Œ';
                registerFields.style.display = 'none';
            }
        }

        // å¤„ç†è®¤è¯è¡¨å•æäº¤
        async function handleAuthSubmit(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value.trim();
            const authMessage = document.getElementById('authMessage');

            // æ¸…é™¤ä¹‹å‰çš„ä¿¡æ¯
            authMessage.classList.add('hidden');
            authMessage.textContent = '';

            // åŸºæœ¬éªŒè¯
            if (!username) {
                showAuthMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }

            if (!password) {
                showAuthMessage('è¯·è¾“å…¥å¯†ç ', 'error');
                return;
            }

            if (isRegisterMode && username.length < 3) {
                showAuthMessage('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦', 'error');
                return;
            }

            if (isRegisterMode && password.length < 6) {
                showAuthMessage('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            const authButton = document.getElementById('authButton');
            authButton.disabled = true;
            authButton.textContent = isRegisterMode ? 'æ³¨å†Œä¸­...' : 'ç™»å½•ä¸­...';

            try {
                if (isRegisterMode) {
                    await register(username, password, email);
                } else {
                    await login(username, password);
                }
            } catch (error) {
                console.error('è®¤è¯é”™è¯¯:', error);
                showAuthMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // é‡æ–°å¯ç”¨æŒ‰é’®
                authButton.disabled = false;
                authButton.textContent = isRegisterMode ? 'æ³¨å†Œ' : 'ç™»å½•';
            }
        }

        // æ˜¾ç¤ºè®¤è¯æ¶ˆæ¯
        function showAuthMessage(message, type) {
            const authMessage = document.getElementById('authMessage');
            authMessage.textContent = message;
            authMessage.className = `auth-message ${type}-message`;
            authMessage.classList.remove('hidden');
        }

        // ä¿®æ”¹æ³¨å†Œå‡½æ•°ï¼Œç§»é™¤å¤´åƒä¸Šä¼ 
        async function register(username, password, email) {
            console.log('å¼€å§‹æ³¨å†Œ:', username);

            try {
                const baseUrl = getBaseUrl();

                // æ‰§è¡Œæ³¨å†Œï¼ˆä¸å†ä¸Šä¼ å¤´åƒï¼‰
                const registerResponse = await fetch(`${baseUrl}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: email || null
                    })
                });

                console.log('æ³¨å†Œå“åº”çŠ¶æ€:', registerResponse.status);

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = registerResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await registerResponse.text();
                    console.error('éJSONå“åº”:', text.substring(0, 200));
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${registerResponse.status} ${registerResponse.statusText}`);
                }

                const data = await registerResponse.json();
                console.log('æ³¨å†Œå“åº”æ•°æ®:', data);

                if (registerResponse.ok && data.success) {
                    showAuthMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('email').value = '';

                    // åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
                    setTimeout(() => {
                        toggleAuthMode();
                    }, 1500);
                } else {
                    showAuthMessage('æ³¨å†Œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', error);
                showAuthMessage('æ³¨å†Œè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç”¨æˆ·ç™»å½•
        async function login(username, password) {
            console.log('å¼€å§‹ç™»å½•:', username);

            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                console.log('ç™»å½•å“åº”çŠ¶æ€:', response.status);

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('éJSONå“åº”:', text.substring(0, 200));
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ç™»å½•å“åº”æ•°æ®:', data);

                if (response.ok && data.success) {
                    sessionToken = data.session_token;
                    currentUser = data.user;

                    // ä¿å­˜tokenåˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('sessionToken', sessionToken);

                    // ç«‹å³è·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¤´åƒï¼‰
                    await updateUserProfile();

                    // æ›´æ–°ç•Œé¢
                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                    updateAvatarDisplay();
                    showMainApp();
                    showAuthMessage('ç™»å½•æˆåŠŸï¼', 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';

                    log('ç™»å½•æˆåŠŸï¼æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'success');
                } else {
                    showAuthMessage('ç™»å½•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                showAuthMessage('ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯ä¼šè¯
        async function verifySession() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                    updateAvatarDisplay();
                    showMainApp();
                    console.log('è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                    log('è‡ªåŠ¨ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    // tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('sessionToken');
                    sessionToken = null;
                    showAuthSection();
                }
            } catch (error) {
                console.error('éªŒè¯ä¼šè¯å¤±è´¥:', error);
                localStorage.removeItem('sessionToken');
                sessionToken = null;
                showAuthSection();
            }
        }

        // ç”¨æˆ·é€€å‡ºç™»å½•
        async function logout() {
            console.log('å¼€å§‹é€€å‡ºç™»å½•');

            try {
                const baseUrl = getBaseUrl();
                await fetch(`${baseUrl}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });
                console.log('é€€å‡ºç™»å½•APIè°ƒç”¨æˆåŠŸ');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•APIè°ƒç”¨å¤±è´¥:', error);
                // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­æ‰§è¡Œæœ¬åœ°æ¸…ç†
            }

            // æ¸…é™¤æœ¬åœ°çŠ¶æ€
            localStorage.removeItem('sessionToken');
            sessionToken = null;
            currentUser = null;

            // æ–­å¼€WebSocketè¿æ¥
            if (socket) {
                socket.disconnect();
                isConnected = false;
                console.log('WebSocketè¿æ¥å·²æ–­å¼€');
            }

            // é‡ç½®UIçŠ¶æ€
            resetUI();

            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '';

            // é‡ç½®å¤´åƒæ˜¾ç¤º
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.src = `${getBaseUrl()}/api/avatar/default.png`;

            // æ˜¾ç¤ºç™»å½•ç•Œé¢
            showAuthSection();
            console.log('å·²é€€å‡ºç™»å½•');
            log('å·²é€€å‡ºç™»å½•', 'info');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // å¦‚æœæ˜¯å†å²è®°å½•æ ‡ç­¾ï¼ŒåŠ è½½å†å²æ•°æ®
            if (tabName === 'history') {
                loadHistory();
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            switchTab('history');
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const loadingEl = document.getElementById('historyLoading');
            const contentEl = document.getElementById('historyContent');
            const emptyEl = document.getElementById('historyEmpty');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            emptyEl.classList.add('hidden');

            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistory(data.history);
                } else {
                    throw new Error('åŠ è½½å†å²è®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                log('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
        function displayHistory(history) {
            const loadingEl = document.getElementById('historyLoading');
            const contentEl = document.getElementById('historyContent');
            const emptyEl = document.getElementById('historyEmpty');

            loadingEl.classList.add('hidden');

            if (history.length === 0) {
                emptyEl.classList.remove('hidden');
                contentEl.classList.add('hidden');
                return;
            }

            contentEl.classList.remove('hidden');
            contentEl.innerHTML = '';

            history.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => viewHistoryDetail(item.process_id);

                card.innerHTML = `
                    ${item.preview_image ?
                        `<img src="${item.preview_image}" alt="é¢„è§ˆå›¾" class="history-preview" onerror="this.style.display='none'">` :
                        '<div class="history-preview">æš‚æ— é¢„è§ˆå›¾ç‰‡</div>'
                    }
                    <div class="history-title">${item.title || 'æœªå‘½åæ¼«ç”»'}</div>
                    ${item.description ? `<div class="history-description">${item.description}</div>` : ''}
                    <div class="history-date">${new Date(item.created_at).toLocaleString()}</div>
                    <div class="history-scenes">${item.total_scenes} å¼ å›¾ç‰‡</div>
                `;

                contentEl.appendChild(card);
            });
        }

        // æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…
        async function viewHistoryDetail(processId) {
            console.log('æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…:', processId);
            openHistoryModal();

            try {
                showModalLoading();

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/history/${processId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistoryDetail(data.history);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•è¯¦æƒ…å¤±è´¥:', error);
                showModalError('åŠ è½½å¤±è´¥: ' + error.message);
                log('åŠ è½½å†å²è®°å½•è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰“å¼€å†å²è®°å½•æ¨¡æ€æ¡†
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            // ç¦ç”¨èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = '';
            // é‡ç½®æ¨¡æ€æ¡†å†…å®¹
            resetModal();
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†åŠ è½½çŠ¶æ€
        function showModalLoading() {
            document.getElementById('modalLoading').classList.remove('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†é”™è¯¯çŠ¶æ€
        function showModalError(message) {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.remove('hidden');
            document.getElementById('modalErrorMessage').textContent = message;
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†å†…å®¹
        function showModalContent() {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.remove('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†ç©ºçŠ¶æ€
        function showModalEmpty() {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.remove('hidden');
        }

        // é‡ç½®æ¨¡æ€æ¡†
        function resetModal() {
            document.getElementById('modalProcessId').textContent = '';
            document.getElementById('modalComicTitle').textContent = '';
            document.getElementById('modalComicDescription').textContent = '';
            document.getElementById('modalCreatedAt').textContent = '';
            document.getElementById('modalScenesCount').textContent = '';
            document.getElementById('modalComicsGrid').innerHTML = '';
        }

        // æ˜¾ç¤ºå†å²è®°å½•è¯¦æƒ…
        function displayHistoryDetail(history) {
            if (!history) {
                showModalEmpty();
                return;
            }

            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            document.getElementById('modalProcessId').textContent = history.process_id;
            document.getElementById('modalComicTitle').textContent = history.title || 'æœªå‘½åæ¼«ç”»';
            document.getElementById('modalComicDescription').textContent = history.description || 'æ— æè¿°';
            document.getElementById('modalCreatedAt').textContent = new Date(history.created_at).toLocaleString();
            document.getElementById('modalScenesCount').textContent = history.comic_results ? history.comic_results.length : 0;

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('modalTitle').textContent = history.title || 'æ¼«ç”»è¯¦æƒ…';

            // æ˜¾ç¤ºå›¾ç‰‡å†…å®¹
            const comicsGrid = document.getElementById('modalComicsGrid');
            comicsGrid.innerHTML = '';

            if (history.comic_results && history.comic_results.length > 0) {
                history.comic_results.forEach((scene, index) => {
                    const sceneCard = document.createElement('div');
                    sceneCard.className = 'modal-comic-card';

                    sceneCard.innerHTML = `
                        <div class="modal-comic-image">
                            <img src="${scene.url}"
                                 alt="åœºæ™¯ ${scene.scene_index}"
                                 style="width: 100%; height: 100%; object-fit: cover;"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=å›¾ç‰‡åŠ è½½å¤±è´¥'">
                        </div>
                        <div class="modal-comic-info">
                            <div class="modal-comic-title">åœºæ™¯ ${scene.scene_index}</div>
                            <div class="modal-comic-description">
                                ${getSceneDescription(history.llm_result, scene.scene_index)}
                            </div>
                        </div>
                    `;

                    comicsGrid.appendChild(sceneCard);
                });
            } else {
                comicsGrid.innerHTML = `
                    <div class="modal-empty" style="grid-column: 1 / -1;">
                        <div style="font-size: 16px; margin-bottom: 10px;">æ²¡æœ‰ç”Ÿæˆå›¾ç‰‡</div>
                        <div style="color: #999; font-size: 14px;">è¯¥è®°å½•æ²¡æœ‰ç”Ÿæˆè¿ç¯ç”»å›¾ç‰‡</div>
                    </div>
                `;
            }

            showModalContent();
        }

        // è·å–åœºæ™¯æè¿°
        function getSceneDescription(llmResult, sceneIndex) {
            if (!llmResult || !llmResult.scenes_detail) {
                return 'æš‚æ— æè¿°';
            }

            const scenes = llmResult.scenes_detail;
            const index = parseInt(sceneIndex) - 1;

            if (index >= 0 && index < scenes.length) {
                const description = scenes[index];
                // é™åˆ¶æè¿°é•¿åº¦ï¼Œé¿å…æ˜¾ç¤ºè¿‡é•¿
                return description.length > 150 ? description.substring(0, 150) + '...' : description;
            }

            return 'æš‚æ— æè¿°';
        }

        // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€æ¡†çš„æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('historyModal');
                if (!modal.classList.contains('hidden')) {
                    closeHistoryModal();
                }
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('historyModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHistoryModal();
            }
        });

        // WebSocketè¿æ¥å‡½æ•°
        function connect() {
            if (isConnected) {
                log('å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨', 'info');
                return;
            }

            if (!sessionToken) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateStatus('æ­£åœ¨è¿æ¥...', 'connecting');
            log('æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');

            try {
                const serverAddress = document.getElementById('serverAddress').value || 'http://10.201.202.108:5000';
                log(`å°è¯•è¿æ¥åˆ°æœåŠ¡å™¨: ${serverAddress}`, 'info');

                // åˆ›å»ºæ–°çš„Socketè¿æ¥
                socket = io(serverAddress, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false,
                    auth: {
                        token: sessionToken
                    }
                });

                // è¿æ¥è¶…æ—¶å¤„ç†
                const connectionTimeout = setTimeout(() => {
                    if (!isConnected) {
                        log('è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œè¿æ¥', 'error');
                        updateStatus('è¿æ¥è¶…æ—¶', 'disconnected');
                        if (socket) socket.disconnect();
                    }
                }, 10000);

                socket.on('connect', () => {
                    clearTimeout(connectionTimeout);
                    isConnected = true;
                    updateStatus('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'connected');
                    log('æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨', 'success');

                    // å‘é€è®¤è¯ä¿¡æ¯
                    socket.emit('authenticate', { session_token: sessionToken });
                });

                socket.on('authentication_result', (data) => {
                    if (data.success) {
                        log('WebSocketè®¤è¯æˆåŠŸ', 'success');
                    } else {
                        log('WebSocketè®¤è¯å¤±è´¥: ' + data.error, 'error');
                        disconnect();
                    }
                });

                socket.on('disconnect', (reason) => {
                    isConnected = false;
                    updateStatus('å·²æ–­å¼€è¿æ¥: ' + reason, 'disconnected');
                    log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥: ' + reason, 'error');
                    resetUI();
                });

                socket.on('connect_error', (error) => {
                    clearTimeout(connectionTimeout);
                    updateStatus('è¿æ¥å¤±è´¥', 'disconnected');
                    log('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                    log('è¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸', 'error');
                });

                // æ–‡æœ¬å¤„ç†å®Œæˆäº‹ä»¶
                socket.on('text_processing_complete', (data) => {
                    log('æ–‡æœ¬å¤„ç†å®Œæˆ!', 'success');
                    currentProcessId = data.process_id;
                    log(`ä¿å­˜å¤„ç†ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                socket.on('full_process_text_complete', (data) => {
                    log('å®Œæ•´æµç¨‹ - æ–‡æœ¬å¤„ç†å®Œæˆ!', 'success');
                    currentProcessId = data.process_id;
                    log(`ä¿å­˜å¤„ç†ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                // å›¾ç‰‡ç”Ÿæˆè¿›åº¦äº‹ä»¶
                socket.on('generation_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                socket.on('full_process_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                // å›¾ç‰‡ç”Ÿæˆå®Œæˆäº‹ä»¶
                socket.on('comics_generation_complete', (data) => {
                    log('è¿ç¯ç”»ç”Ÿæˆå®Œæˆ!', 'success');
                    displayImagesResult(data);
                });

                socket.on('full_process_complete', (data) => {
                    log('å®Œæ•´æµç¨‹å¤„ç†å®Œæˆ!', 'success');
                    displayImagesResult(data);
                    // ç”Ÿæˆå®Œæˆååˆ·æ–°å†å²è®°å½•
                    if (document.getElementById('historyTab').classList.contains('active')) {
                        loadHistory();
                    }
                });

                // é”™è¯¯å¤„ç†äº‹ä»¶
                socket.on('process_error', (data) => {
                    log(`å¤„ç†é”™è¯¯: ${data.error}`, 'error');
                    resetUI();
                });

                socket.on('generation_error', (data) => {
                    log(`ç”Ÿæˆé”™è¯¯: ${data.error}`, 'error');
                    hideProgressSection();
                });

                socket.on('full_process_error', (data) => {
                    log(`å®Œæ•´æµç¨‹é”™è¯¯: ${data.error}`, 'error');
                    resetUI();
                });

            } catch (error) {
                updateStatus('è¿æ¥å¤±è´¥', 'disconnected');
                log('è¿æ¥å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        // æ–­å¼€WebSocketè¿æ¥
        function disconnect() {
            if (socket) {
                socket.disconnect();
                isConnected = false;
                updateStatus('å·²æ‰‹åŠ¨æ–­å¼€è¿æ¥', 'disconnected');
                log('å·²æ‰‹åŠ¨æ–­å¼€è¿æ¥', 'info');
                resetUI();
            } else {
                log('æ²¡æœ‰æ´»åŠ¨çš„è¿æ¥', 'info');
            }
        }

        // ä¿®æ”¹å®Œæ•´æµç¨‹å¤„ç†å‡½æ•°ï¼Œæ·»åŠ æ ‡é¢˜å’Œæè¿°
        function testFullProcess() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            if (!currentUser) {
                log('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('è¯·è¾“å…¥å°è¯´æ–‡æœ¬', 'error');
                return;
            }

            const title = document.getElementById('comicTitle').value;
            const description = document.getElementById('comicDescription').value;

            log('å‘é€å®Œæ•´æµç¨‹è¯·æ±‚...', 'info');
            resetUI();
            socket.emit('full_process', {
                novel_text: novelText,
                title: title,
                description: description
            });
        }

        // æ‰“å¼€å¤´åƒæ¨¡æ€æ¡†
        function openAvatarModal() {
            console.log('æ‰“å¼€å¤´åƒè®¾ç½®');
            updateAvatarModal();
            document.getElementById('avatarModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­å¤´åƒæ¨¡æ€æ¡†
        function closeAvatarModal() {
            console.log('å…³é—­å¤´åƒè®¾ç½®');
            document.getElementById('avatarModal').classList.add('hidden');
            document.body.style.overflow = '';
            resetAvatarUpload();
        }

        // æ›´æ–°å¤´åƒæ¨¡æ€æ¡†å†…å®¹
        function updateAvatarModal() {
            const currentAvatarDisplay = document.getElementById('currentAvatarDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');

            // æ›´æ–°å½“å‰å¤´åƒæ˜¾ç¤º
            if (currentUser && currentUser.avatar) {
                const avatarUrl = `${getBaseUrl()}${currentUser.avatar}`;
                currentAvatarDisplay.src = avatarUrl;
                userAvatar.src = avatarUrl;
                removeAvatarBtn.style.display = 'block';
                console.log('æ›´æ–°æ¨¡æ€æ¡†å¤´åƒæ˜¾ç¤º:', avatarUrl);
            } else {
                const defaultAvatar = `${getBaseUrl()}/api/avatar/default.png`;
                currentAvatarDisplay.src = defaultAvatar;
                userAvatar.src = defaultAvatar;
                removeAvatarBtn.style.display = 'none';
                console.log('æ›´æ–°æ¨¡æ€æ¡†ä¸ºé»˜è®¤å¤´åƒ:', defaultAvatar);
            }
        }

        // ç¡®ä¿ initAvatarUpload å‡½æ•°å­˜åœ¨
        function initAvatarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('avatarFileInput');

            if (!uploadArea || !fileInput) {
                console.error('æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸæˆ–æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                return;
            }

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });

            console.log('å¤´åƒä¸Šä¼ åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(file) {
            console.log('é€‰æ‹©æ–‡ä»¶:', file);

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œå¤§å°
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const maxSize = 2 * 1024 * 1024; // 2MB

            if (!allowedTypes.includes(file.type)) {
                log('è¯·é€‰æ‹© JPGã€PNG æˆ– GIF æ ¼å¼çš„å›¾ç‰‡', 'error');
                return;
            }

            if (file.size > maxSize) {
                log('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB', 'error');
                return;
            }

            selectedAvatarFile = file;

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatarPreview').src = e.target.result;
                document.getElementById('uploadPreview').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('hidden');
            };
            reader.readAsDataURL(file);

            log('å·²é€‰æ‹©å›¾ç‰‡ï¼Œç‚¹å‡»"ç¡®è®¤ä¸Šä¼ "åº”ç”¨æ–°å¤´åƒ', 'info');
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload() {
            resetAvatarUpload();
            log('å·²å–æ¶ˆå›¾ç‰‡é€‰æ‹©', 'info');
        }

        // é‡ç½®ä¸Šä¼ çŠ¶æ€
        function resetAvatarUpload() {
            selectedAvatarFile = null;
            document.getElementById('avatarFileInput').value = '';
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
        }

        // æ·»åŠ è°ƒè¯•å‡½æ•°
        function debugAvatarUpload() {
            console.log('=== å¤´åƒä¸Šä¼ è°ƒè¯•ä¿¡æ¯ ===');
            console.log('selectedAvatarFile:', selectedAvatarFile);
            console.log('sessionToken:', sessionToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('currentUser:', currentUser);
            console.log('baseUrl:', getBaseUrl());
            console.log('========================');
        }

        // ä¸Šä¼ å¤´åƒ
        async function uploadAvatar() {
            debugAvatarUpload(); // æ·»åŠ è¿™è¡Œ

            if (!selectedAvatarFile) {
                log('è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error');
                return;
            }

            try {
                log('æ­£åœ¨ä¸Šä¼ å¤´åƒ...', 'info');

                const formData = new FormData();
                formData.append('avatar', selectedAvatarFile);

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: formData
                });

                // æ·»åŠ å“åº”çŠ¶æ€æ£€æŸ¥
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ä¸Šä¼ å¤±è´¥å“åº”:', errorText);
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('éJSONå“åº”:', text.substring(0, 200));
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ä¸Šä¼ å“åº”æ•°æ®:', data);

                if (data.success) {
                    log('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');

                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    await updateUserProfile();

                    // é‡ç½®ä¸Šä¼ çŠ¶æ€
                    resetAvatarUpload();
                    closeAvatarModal();
                } else {
                    throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
                log('ä¸Šä¼ å¤´åƒå¤±è´¥: ' + error.message, 'error');

                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('401')) {
                    log('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                } else if (error.message.includes('413')) {
                    log('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡', 'error');
                } else if (error.message.includes('400')) {
                    log('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹©JPGã€PNGæˆ–GIFæ ¼å¼', 'error');
                }
            }
        }

        // ç§»é™¤å¤´åƒ
        async function removeAvatar() {
            if (!confirm('ç¡®å®šè¦ç§»é™¤å½“å‰å¤´åƒå—ï¼Ÿ')) {
                return;
            }

            try {
                log('æ­£åœ¨ç§»é™¤å¤´åƒ...', 'info');

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/avatar`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('å¤´åƒç§»é™¤æˆåŠŸï¼', 'success');

                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    await updateUserProfile();
                    closeAvatarModal();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç§»é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('ç§»é™¤å¤´åƒå¤±è´¥:', error);
                log('ç§»é™¤å¤´åƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆè·å–æœ€æ–°å¤´åƒï¼‰
        async function updateUserProfile() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAvatarDisplay();
                    console.log('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼Œå¤´åƒ:', currentUser.avatar);
                } else {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åœ¨ updateAvatarDisplay å‡½æ•°ä¸­æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
        function updateAvatarDisplay() {
            const userAvatar = document.getElementById('userAvatar');
            console.log('updateAvatarDisplay è¢«è°ƒç”¨ï¼ŒcurrentUser:', currentUser);

            if (currentUser && currentUser.avatar) {
                const avatarUrl = `${getBaseUrl()}${currentUser.avatar}`;
                userAvatar.src = avatarUrl;
                console.log('è®¾ç½®è‡ªå®šä¹‰å¤´åƒ URL:', avatarUrl);

                // æ·»åŠ åŠ è½½æˆåŠŸå’Œå¤±è´¥çš„ç›‘å¬å™¨
                userAvatar.onload = function() {
                    console.log('å¤´åƒåŠ è½½æˆåŠŸ:', avatarUrl);
                };
            } else {
                const defaultAvatar = `${getBaseUrl()}/api/avatar/default.png`;
                userAvatar.src = defaultAvatar;
                console.log('è®¾ç½®é»˜è®¤å¤´åƒ URL:', defaultAvatar);
            }

            userAvatar.onerror = function() {
                console.warn('å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                this.src = `${getBaseUrl()}/api/avatar/default.png`;
            };
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å¤´åƒåŠŸèƒ½');
            initAvatarUpload();

            // å¦‚æœå·²ç»ç™»å½•ï¼Œæ›´æ–°å¤´åƒæ˜¾ç¤º
            if (currentUser) {
                updateAvatarDisplay();
            }
        });

        // åŸæœ‰çš„å…¶ä»–å‡½æ•°ä¿æŒä¸å˜...
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;

            if (type === 'error') {
                logEntry.style.color = 'red';
                logEntry.style.borderLeftColor = '#dc3545';
            } else if (type === 'success') {
                logEntry.style.color = 'green';
                logEntry.style.borderLeftColor = '#28a745';
            } else if (type === 'warning') {
                logEntry.style.color = 'orange';
                logEntry.style.borderLeftColor = '#ffc107';
            }

            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateStatus(message, status) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${status}`;
        }

        function testProcessNovel() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('è¯·è¾“å…¥å°è¯´æ–‡æœ¬', 'error');
                return;
            }

            log('å‘é€å°è¯´å¤„ç†è¯·æ±‚...', 'info');
            resetUI();
            socket.emit('process_novel', { novel_text: novelText });
        }

        function generateComicsFromText() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            if (!currentProcessId) {
                log('è¯·å…ˆå®Œæˆæ–‡æœ¬å¤„ç†', 'error');
                console.log(`å½“å‰å¤„ç†ID: ${currentProcessId}`);
                return;
            }

            log(`å¼€å§‹ç”Ÿæˆè¿ç¯ç”»ï¼Œå¤„ç†ID: ${currentProcessId}`, 'info');
            showProgressSection();
            socket.emit('start_comics_generation', { process_id: currentProcessId });
        }

        function displayTextResult(data) {
            const textResultSection = document.getElementById('textResultSection');
            const textResultContent = document.getElementById('textResultContent');

            let html = `
                <div style="margin-bottom: 20px;">
                    <p><strong>å¤„ç†ID:</strong> ${data.process_id}</p>
                    <p><strong>åœºæ™¯æ•°é‡:</strong> ${data.scenes_count}</p>
                </div>
            `;

            if (data.character_consistency && Object.keys(data.character_consistency).length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <p><strong>è§’è‰²è®¾å®š:</strong></p>
                    <ul style="list-style: none; padding: 0;">`;
                for (const [name, desc] of Object.entries(data.character_consistency)) {
                    html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>${name}:</strong> ${desc}</li>`;
                }
                html += `</ul></div>`;
            }

            if (data.environment_consistency && Object.keys(data.environment_consistency).length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <p><strong>ç¯å¢ƒè®¾å®š:</strong></p>
                    <ul style="list-style: none; padding: 0;">`;
                for (const [env, desc] of Object.entries(data.environment_consistency)) {
                    html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>${env}:</strong> ${desc}</li>`;
                }
                html += `</ul></div>`;
            }

            if (data.scenes_detail) {
                html += `<div><p><strong>åœºæ™¯è¯¦æƒ…:</strong></p>`;
                data.scenes_detail.forEach((scene, index) => {
                    html += `
                        <div class="scene-card">
                            <h4>åœºæ™¯ ${index + 1}</h4>
                            <p>${scene}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (data.scenes_preview) {
                html += `<div><p><strong>åœºæ™¯é¢„è§ˆ:</strong></p>`;
                data.scenes_preview.forEach(scene => {
                    html += `
                        <div class="scene-card">
                            <h4>åœºæ™¯ ${scene.scene_index}</h4>
                            <p>${scene.description}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            textResultContent.innerHTML = html;
            textResultSection.classList.remove('hidden');

            // ç¡®ä¿ç”ŸæˆæŒ‰é’®å¯ç”¨
            document.getElementById('generateComicsBtn').disabled = false;
        }

        function displayImagesResult(data) {
            hideProgressSection();
            const imagesResultSection = document.getElementById('imagesResultSection');
            const imagesResultContent = document.getElementById('imagesResultContent');

            let html = `<p style="margin-bottom: 20px;"><strong>ç”Ÿæˆå›¾ç‰‡æ•°é‡:</strong> ${data.total_scenes}</p>`;

            if (data.comic_results && data.comic_results.length > 0) {
                data.comic_results.forEach(scene => {
                    html += `
                        <div class="image-card">
                            <h4>åœºæ™¯ ${scene.scene_index}</h4>
                            <img src="${scene.url}" alt="åœºæ™¯ ${scene.scene_index}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=å›¾ç‰‡åŠ è½½å¤±è´¥'">
                        </div>
                    `;
                });
            } else {
                html += `<p>æ²¡æœ‰ç”Ÿæˆå›¾ç‰‡</p>`;
            }

            imagesResultContent.innerHTML = html;
            imagesResultSection.classList.remove('hidden');
        }

        function updateProgress(current, total, message) {
            showProgressSection();
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = Math.round((current / total) * 100);

            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${message} (${current}/${total})`;

            log(`è¿›åº¦: ${message} (${current}/${total})`, 'info');
        }

        function showProgressSection() {
            document.getElementById('progressSection').classList.remove('hidden');
        }

        function hideProgressSection() {
            document.getElementById('progressSection').classList.add('hidden');
        }

        function resetUI() {
            document.getElementById('textResultSection').classList.add('hidden');
            document.getElementById('imagesResultSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            currentProcessId = null;
            document.getElementById('generateComicsBtn').disabled = false;
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                testFullProcess();
            }
            if (event.key === 'Escape') {
                disconnect();
            }
        });
    </script>
</body>
</html>