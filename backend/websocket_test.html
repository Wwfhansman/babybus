<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说转连环画系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* 登录/注册界面样式 */
        .auth-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .auth-switch-text {
            color: #666;
            font-size: 14px;
        }

        .auth-switch-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .auth-switch-link:hover {
            color: #764ba2;
        }

        .auth-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .error-message {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #363;
            border: 1px solid #cfc;
        }

        /* 注册页面头像上传样式 */
        .avatar-upload-register {
            border: 2px dashed #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }

        /* 头像上传标签样式 */
        .avatar-upload-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
            cursor: default; /* 因为实际点击的是按钮，所以这里不需要指针 */
        }

        .avatar-preview-register {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #e1e5e9;
            background: #fff;
        }

        .avatar-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-default-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 12px;
            text-align: center;
        }

        .avatar-upload-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .small-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .avatar-upload-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        .avatar-preview-register.has-image .avatar-default-text {
            display: none;
        }

        .avatar-preview-register.has-image .avatar-preview-img {
            display: block;
        }

        /* 主应用界面样式 */
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .app-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-welcome {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* 内容区域 */
        .app-content {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }

        .status {
            padding: 12px 20px;
            margin: 0 0 20px 0;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connected::before {
            background: #28a745;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .disconnected::before {
            background: #dc3545;
        }

        .connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .connecting::before {
            background: #ffc107;
        }

        /* 连接控制 */
        .connection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .server-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
        }

        .connect-btn, .disconnect-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .connect-btn {
            background: #28a745;
            color: white;
        }

        .connect-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .disconnect-btn {
            background: #6c757d;
            color: white;
        }

        .disconnect-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* 导航标签 */
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .nav-tab:hover:not(.active) {
            color: #333;
            background: rgba(0, 0, 0, 0.03);
        }

        /* 标签内容 */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content.active {
            display: block;
        }

        /* 功能区域 */
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e5e9;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }

        .title-input {
            margin-bottom: 20px;
        }

        .title-input input,
        .title-input textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .title-input input:focus,
        .title-input textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .title-input textarea {
            height: 80px;
            resize: vertical;
        }

        .novel-textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .novel-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .primary-btn, .secondary-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .secondary-btn:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .primary-btn:disabled, .secondary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* 场景卡片 */
        .scene-card {
            border: 1px solid #e1e5e9;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .scene-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .scene-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        /* 图片容器 */
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            border: 1px solid #e1e5e9;
            padding: 15px;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .image-card h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        /* 日志区域 */
        .log {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e5e9;
        }

        .log h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .log-output {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .log-time {
            color: #666;
            font-size: 0.85em;
            margin-right: 10px;
        }

        /* 历史记录 */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .history-card {
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .history-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .history-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .history-date {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .history-scenes {
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
        }

        /* 模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-info {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .modal-info p {
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .modal-info strong {
            color: #333;
        }

        .modal-comics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .modal-comic-card {
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
        }

        .modal-comic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .modal-comic-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .modal-comic-info {
            padding: 20px;
        }

        .modal-comic-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .modal-comic-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .modal-error {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 10px;
            margin: 20px 0;
        }

        .modal-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 20px;
                max-height: calc(95vh - 120px);
            }

            .modal-comics-grid {
                grid-template-columns: 1fr;
            }

            .modal-comic-image {
                height: 200px;
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .app-content {
                padding: 20px;
            }

            .user-info {
                position: static;
                justify-content: flex-end;
                margin-top: 15px;
            }

            .connection-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .server-input {
                min-width: auto;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .image-container {
                grid-template-columns: 1fr;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* 头像相关样式 */
        .user-avatar-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            cursor: pointer;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .avatar-upload-tip {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .user-avatar-container:hover .avatar-upload-tip {
            opacity: 1;
        }

        /* 头像上传模态框样式 */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .current-avatar, .avatar-upload-options {
            text-align: center;
        }

        .current-avatar h3, .avatar-upload-options h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e1e5e9;
            margin: 0 auto;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2f5;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8f4fd;
        }

        .upload-placeholder {
            color: #666;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .upload-preview {
            text-align: center;
        }

        .upload-preview h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .user-avatar {
                width: 40px;
                height: 40px;
            }

            .avatar-upload-tip {
                display: none;
            }

            .preview-actions, .avatar-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
        <!-- 登录/注册界面 -->
        <div id="authSection">
        <div class="auth-background"></div>
        <div class="auth-container">
            <div class="auth-header">
                <h2 id="authTitle">欢迎回来</h2>
                <p id="authSubtitle">请登录您的账户继续使用</p>
            </div>
            <form id="authForm" class="auth-form">
                <div id="registerFields" style="display: none;">
                    <div class="form-group">
                        <label for="email">邮箱地址</label>
                        <input type="email" id="email" placeholder="请输入邮箱地址（可选）">
                    </div>
                </div>
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" placeholder="请输入用户名" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" placeholder="请输入密码" required>
                </div>
                <div id="authMessage" class="auth-message hidden"></div>
                <button type="submit" id="authButton" class="auth-button">登录</button>
            </form>
            <div class="auth-switch">
                <span class="auth-switch-text" id="authSwitchText">还没有账号？</span>
                <a class="auth-switch-link" id="authSwitchLink" onclick="toggleAuthMode()">立即注册</a>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="mainApp" class="container hidden">
        <div class="app-header">
            <h1>小说转连环画系统</h1>
            <p>将您的小说文本转换为精美的连环画</p>
            <div class="user-info">
                <!-- 添加头像显示 -->
                <div class="user-avatar-container">
                    <img id="userAvatar" src="" alt="头像" class="user-avatar" onclick="openAvatarModal()">
                    <div class="avatar-upload-tip">点击修改头像</div>
                </div>
                <span class="user-welcome">欢迎，<span id="usernameDisplay"></span></span>
                <button onclick="showHistory()" class="header-button">历史记录</button>
                <button onclick="logout()" class="header-button">退出登录</button>
            </div>
        </div>

        <div class="app-content">
            <div class="status disconnected" id="status">
                <span>未连接到服务器</span>
            </div>

            <div class="connection-controls">
                <input type="text" id="serverAddress" value="http://139.224.101.91:5000"
                       placeholder="服务器地址" class="server-input">
                <button class="connect-btn" onclick="connect()">连接服务器</button>
                <button class="disconnect-btn" onclick="disconnect()">断开连接</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('generate')">生成漫画</button>
                <button class="nav-tab" onclick="switchTab('history')">历史记录</button>
            </div>

            <!-- 生成漫画标签页 -->
            <div id="generateTab" class="tab-content active">
                <div class="section">
                    <h3>创作您的漫画</h3>

                    <div class="title-input">
                        <input type="text" id="comicTitle" placeholder="为您的漫画起个标题（可选）">
                        <textarea id="comicDescription" placeholder="添加一些描述（可选）"></textarea>
                    </div>

                    <textarea id="novelText" class="novel-textarea" placeholder="在这里输入您的小说文本...">小明是一个勇敢的少年。一天，他在森林里遇到了一只受伤的小鹿。小明小心翼翼地接近小鹿，发现它的腿受伤了。他用自己的手帕为小鹿包扎伤口，然后帮助小鹿找到了它的妈妈。小鹿和它的妈妈都很感激小明，他们成为了好朋友。</textarea>

                    <div class="action-buttons">
                        <button class="primary-btn" onclick="testFullProcess()">完整流程处理</button>
                        <button class="secondary-btn" onclick="testProcessNovel()">仅处理文本</button>
                    </div>
                </div>

                <!-- 文本处理结果区域 -->
                <div id="textResultSection" class="section hidden">
                    <h3>文本处理结果</h3>
                    <div id="textResultContent"></div>
                    <div class="action-buttons">
                        <button id="generateComicsBtn" class="primary-btn" onclick="generateComicsFromText()">生成连环画</button>
                    </div>
                </div>

                <!-- 图片生成进度区域 -->
                <div id="progressSection" class="section hidden">
                    <h3>图片生成进度</h3>
                    <div class="progress-text" id="progressText">准备开始...</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 图片显示区域 -->
                <div id="imagesResultSection" class="section hidden">
                    <h3>生成的连环画</h3>
                    <div id="imagesResultContent" class="image-container"></div>
                </div>
            </div>

            <!-- 历史记录标签页 -->
            <div id="historyTab" class="tab-content">
                <div class="section">
                    <h3>我的漫画历史</h3>
                    <div class="history-container">
                        <div id="historyLoading" style="text-align: center; padding: 40px;">
                            <div style="color: #666; font-size: 16px;">加载中...</div>
                        </div>
                        <div id="historyContent" class="history-grid hidden"></div>
                        <div id="historyEmpty" style="text-align: center; padding: 40px;" class="hidden">
                            <div style="color: #666; font-size: 16px; margin-bottom: 20px;">
                                还没有生成过漫画
                            </div>
                            <button class="primary-btn" onclick="switchTab('generate')">去生成第一本漫画</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="log">
                <h3>系统日志</h3>
                <div id="logOutput" class="log-output"></div>
            </div>
        </div>
    </div>

        <!-- 历史记录详情模态框 -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">漫画详情</h2>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" class="modal-loading">
                    <div style="font-size: 16px; margin-bottom: 10px;">加载中...</div>
                    <div style="color: #999; font-size: 14px;">正在获取漫画详情</div>
                </div>

                <div id="modalContent" class="hidden">
                    <div class="modal-info">
                        <p><strong>处理ID:</strong> <span id="modalProcessId"></span></p>
                        <p><strong>标题:</strong> <span id="modalComicTitle"></span></p>
                        <p><strong>描述:</strong> <span id="modalComicDescription"></span></p>
                        <p><strong>创建时间:</strong> <span id="modalCreatedAt"></span></p>
                        <p><strong>场景数量:</strong> <span id="modalScenesCount"></span></p>
                    </div>

                    <div id="modalImagesContent">
                        <h3 style="margin-bottom: 20px; color: #333;">连环画场景</h3>
                        <div id="modalComicsGrid" class="modal-comics-grid"></div>
                    </div>
                </div>

                <div id="modalError" class="modal-error hidden">
                    <div style="font-size: 16px; margin-bottom: 10px;">加载失败</div>
                    <div style="font-size: 14px;" id="modalErrorMessage"></div>
                    <button class="primary-btn" onclick="closeHistoryModal()" style="margin-top: 15px;">关闭</button>
                </div>

                <div id="modalEmpty" class="modal-empty hidden">
                    <div style="font-size: 16px; margin-bottom: 10px;">没有找到漫画详情</div>
                    <button class="primary-btn" onclick="closeHistoryModal()" style="margin-top: 15px;">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加头像上传模态框 -->
    <div id="avatarModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>修改头像</h2>
                <button class="modal-close" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avatar-upload-section">
                    <div class="current-avatar">
                        <h3>当前头像</h3>
                        <img id="currentAvatarDisplay" src="" alt="当前头像" class="avatar-preview">
                    </div>

                    <div class="avatar-upload-options">
                        <h3>上传新头像</h3>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-placeholder">
                                <div style="font-size: 48px; margin-bottom: 10px;">📷</div>
                                <div>点击选择图片或拖拽到此处</div>
                                <div class="upload-hint">支持 JPG、PNG、GIF 格式，最大 2MB</div>
                            </div>
                            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                        </div>

                        <div class="upload-preview hidden" id="uploadPreview">
                            <h4>预览</h4>
                            <img id="avatarPreview" src="" alt="预览" class="avatar-preview">
                            <div class="preview-actions">
                                <button class="secondary-btn" onclick="cancelUpload()">取消</button>
                                <button class="primary-btn" onclick="uploadAvatar()">确认上传</button>
                            </div>
                        </div>
                    </div>

                    <div class="avatar-actions">
                        <button class="secondary-btn" onclick="removeAvatar()" id="removeAvatarBtn">移除头像</button>
                        <button class="primary-btn" onclick="closeAvatarModal()">完成</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript代码保持不变，只更新了与界面交互的部分
        // 用户状态管理
        let currentUser = null;
        let sessionToken = localStorage.getItem('sessionToken');
        let isRegisterMode = false;

        // WebSocket相关变量
        let socket = null;
        let isConnected = false;
        let currentProcessId = null;

        // 头像相关功能
        let selectedAvatarFile = null;

        // 注册页面头像上传相关变量
        let registerAvatarFile = null;

        // 获取基础URL
        function getBaseUrl() {
            const serverAddress = document.getElementById('serverAddress').value || 'http://10.201.202.108:5000';
            return serverAddress.replace(/\/$/, '');
        }

        // 修改页面加载函数，初始化注册头像上传
        window.addEventListener('load', function() {
            console.log('页面加载完成，检查登录状态');
            if (sessionToken) {
                console.log('发现保存的sessionToken，尝试自动登录');
                verifySession();
            } else {
                console.log('没有保存的sessionToken，显示登录界面');
                showAuthSection();
            }

            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
        });

        // 显示认证界面
        function showAuthSection() {
            console.log('显示认证界面');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainApp').classList.add('hidden');
        }

        // 显示主应用界面
        function showMainApp() {
            console.log('显示主应用界面');
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');

            // 登录后自动连接服务器
            setTimeout(() => {
                if (!isConnected) {
                    console.log('登录后自动连接服务器');
                    connect();
                }
            }, 500);
        }

        // 初始化注册页面头像上传
        function initRegisterAvatarUpload() {
            const avatarInput = document.getElementById('avatarInputRegister');
            const avatarPreview = document.getElementById('avatarPreviewRegister');
            const avatarPreviewContainer = document.querySelector('.avatar-preview-register');

            avatarInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleRegisterAvatarSelect(e.target.files[0]);
                }
            });

            // 设置默认头像预览
            avatarPreview.src = `${getBaseUrl()}/api/avatar/default.png`;
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const authButton = document.getElementById('authButton');
            const authSwitchText = document.getElementById('authSwitchText');
            const authSwitchLink = document.getElementById('authSwitchLink');
            const registerFields = document.getElementById('registerFields');
            const authMessage = document.getElementById('authMessage');

            // 清除消息
            authMessage.classList.add('hidden');
            authMessage.textContent = '';
            authMessage.className = 'auth-message hidden';

            if (isRegisterMode) {
                authTitle.textContent = '创建账户';
                authSubtitle.textContent = '注册新账户开始使用';
                authButton.textContent = '注册';
                authSwitchText.textContent = '已有账号？';
                authSwitchLink.textContent = '立即登录';
                registerFields.style.display = 'block';
            } else {
                authTitle.textContent = '欢迎回来';
                authSubtitle.textContent = '请登录您的账户继续使用';
                authButton.textContent = '登录';
                authSwitchText.textContent = '还没有账号？';
                authSwitchLink.textContent = '立即注册';
                registerFields.style.display = 'none';
            }
        }

        // 处理认证表单提交
        async function handleAuthSubmit(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value.trim();
            const authMessage = document.getElementById('authMessage');

            // 清除之前的信息
            authMessage.classList.add('hidden');
            authMessage.textContent = '';

            // 基本验证
            if (!username) {
                showAuthMessage('请输入用户名', 'error');
                return;
            }

            if (!password) {
                showAuthMessage('请输入密码', 'error');
                return;
            }

            if (isRegisterMode && username.length < 3) {
                showAuthMessage('用户名至少需要3个字符', 'error');
                return;
            }

            if (isRegisterMode && password.length < 6) {
                showAuthMessage('密码至少需要6个字符', 'error');
                return;
            }

            // 禁用按钮防止重复提交
            const authButton = document.getElementById('authButton');
            authButton.disabled = true;
            authButton.textContent = isRegisterMode ? '注册中...' : '登录中...';

            try {
                if (isRegisterMode) {
                    await register(username, password, email);
                } else {
                    await login(username, password);
                }
            } catch (error) {
                console.error('认证错误:', error);
                showAuthMessage('操作失败，请重试', 'error');
            } finally {
                // 重新启用按钮
                authButton.disabled = false;
                authButton.textContent = isRegisterMode ? '注册' : '登录';
            }
        }

        // 显示认证消息
        function showAuthMessage(message, type) {
            const authMessage = document.getElementById('authMessage');
            authMessage.textContent = message;
            authMessage.className = `auth-message ${type}-message`;
            authMessage.classList.remove('hidden');
        }

        // 修改注册函数，移除头像上传
        async function register(username, password, email) {
            console.log('开始注册:', username);

            try {
                const baseUrl = getBaseUrl();

                // 执行注册（不再上传头像）
                const registerResponse = await fetch(`${baseUrl}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: email || null
                    })
                });

                console.log('注册响应状态:', registerResponse.status);

                // 检查响应内容类型
                const contentType = registerResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await registerResponse.text();
                    console.error('非JSON响应:', text.substring(0, 200));
                    throw new Error(`服务器返回了非JSON响应: ${registerResponse.status} ${registerResponse.statusText}`);
                }

                const data = await registerResponse.json();
                console.log('注册响应数据:', data);

                if (registerResponse.ok && data.success) {
                    showAuthMessage('注册成功！请登录', 'success');

                    // 清空表单
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('email').value = '';

                    // 切换到登录模式
                    setTimeout(() => {
                        toggleAuthMode();
                    }, 1500);
                } else {
                    showAuthMessage('注册失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('注册请求失败:', error);
                showAuthMessage('注册请求失败: ' + error.message, 'error');
            }
        }

        // 用户登录
        async function login(username, password) {
            console.log('开始登录:', username);

            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                console.log('登录响应状态:', response.status);

                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('非JSON响应:', text.substring(0, 200));
                    throw new Error(`服务器返回了非JSON响应: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('登录响应数据:', data);

                if (response.ok && data.success) {
                    sessionToken = data.session_token;
                    currentUser = data.user;

                    // 保存token到本地存储
                    localStorage.setItem('sessionToken', sessionToken);

                    // 立即获取完整的用户信息（包括头像）
                    await updateUserProfile();

                    // 更新界面
                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                    updateAvatarDisplay();
                    showMainApp();
                    showAuthMessage('登录成功！', 'success');

                    // 清空表单
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';

                    log('登录成功！正在连接服务器...', 'success');
                } else {
                    showAuthMessage('登录失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('登录请求失败:', error);
                showAuthMessage('登录请求失败: ' + error.message, 'error');
            }
        }

        // 验证会话
        async function verifySession() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                    updateAvatarDisplay();
                    showMainApp();
                    console.log('自动登录成功');
                    log('自动登录成功！', 'success');
                } else {
                    // token无效，清除本地存储
                    localStorage.removeItem('sessionToken');
                    sessionToken = null;
                    showAuthSection();
                }
            } catch (error) {
                console.error('验证会话失败:', error);
                localStorage.removeItem('sessionToken');
                sessionToken = null;
                showAuthSection();
            }
        }

        // 用户退出登录
        async function logout() {
            console.log('开始退出登录');

            try {
                const baseUrl = getBaseUrl();
                await fetch(`${baseUrl}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });
                console.log('退出登录API调用成功');
            } catch (error) {
                console.error('退出登录API调用失败:', error);
                // 即使API调用失败，也要继续执行本地清理
            }

            // 清除本地状态
            localStorage.removeItem('sessionToken');
            sessionToken = null;
            currentUser = null;

            // 断开WebSocket连接
            if (socket) {
                socket.disconnect();
                isConnected = false;
                console.log('WebSocket连接已断开');
            }

            // 重置UI状态
            resetUI();

            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '';

            // 重置头像显示
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.src = `${getBaseUrl()}/api/avatar/default.png`;

            // 显示登录界面
            showAuthSection();
            console.log('已退出登录');
            log('已退出登录', 'info');
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新标签按钮状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 激活选中的标签
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // 如果是历史记录标签，加载历史数据
            if (tabName === 'history') {
                loadHistory();
            }
        }

        // 显示历史记录
        function showHistory() {
            switchTab('history');
        }

        // 加载历史记录
        async function loadHistory() {
            const loadingEl = document.getElementById('historyLoading');
            const contentEl = document.getElementById('historyContent');
            const emptyEl = document.getElementById('historyEmpty');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            emptyEl.classList.add('hidden');

            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistory(data.history);
                } else {
                    throw new Error('加载历史记录失败');
                }
            } catch (error) {
                console.error('加载历史记录失败:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                log('加载历史记录失败: ' + error.message, 'error');
            }
        }

        // 显示历史记录列表
        function displayHistory(history) {
            const loadingEl = document.getElementById('historyLoading');
            const contentEl = document.getElementById('historyContent');
            const emptyEl = document.getElementById('historyEmpty');

            loadingEl.classList.add('hidden');

            if (history.length === 0) {
                emptyEl.classList.remove('hidden');
                contentEl.classList.add('hidden');
                return;
            }

            contentEl.classList.remove('hidden');
            contentEl.innerHTML = '';

            history.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => viewHistoryDetail(item.process_id);

                card.innerHTML = `
                    ${item.preview_image ?
                        `<img src="${item.preview_image}" alt="预览图" class="history-preview" onerror="this.style.display='none'">` :
                        '<div class="history-preview">暂无预览图片</div>'
                    }
                    <div class="history-title">${item.title || '未命名漫画'}</div>
                    ${item.description ? `<div class="history-description">${item.description}</div>` : ''}
                    <div class="history-date">${new Date(item.created_at).toLocaleString()}</div>
                    <div class="history-scenes">${item.total_scenes} 张图片</div>
                `;

                contentEl.appendChild(card);
            });
        }

        // 查看历史记录详情
        async function viewHistoryDetail(processId) {
            console.log('查看历史记录详情:', processId);
            openHistoryModal();

            try {
                showModalLoading();

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/history/${processId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistoryDetail(data.history);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '加载失败');
                }
            } catch (error) {
                console.error('加载历史记录详情失败:', error);
                showModalError('加载失败: ' + error.message);
                log('加载历史记录详情失败: ' + error.message, 'error');
            }
        }

        // 打开历史记录模态框
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            // 禁用背景滚动
            document.body.style.overflow = 'hidden';
        }

        // 关闭历史记录模态框
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
            // 重置模态框内容
            resetModal();
        }

        // 显示模态框加载状态
        function showModalLoading() {
            document.getElementById('modalLoading').classList.remove('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.add('hidden');
        }

        // 显示模态框错误状态
        function showModalError(message) {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.remove('hidden');
            document.getElementById('modalErrorMessage').textContent = message;
        }

        // 显示模态框内容
        function showModalContent() {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.remove('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.add('hidden');
        }

        // 显示模态框空状态
        function showModalEmpty() {
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('modalEmpty').classList.remove('hidden');
        }

        // 重置模态框
        function resetModal() {
            document.getElementById('modalProcessId').textContent = '';
            document.getElementById('modalComicTitle').textContent = '';
            document.getElementById('modalComicDescription').textContent = '';
            document.getElementById('modalCreatedAt').textContent = '';
            document.getElementById('modalScenesCount').textContent = '';
            document.getElementById('modalComicsGrid').innerHTML = '';
        }

        // 显示历史记录详情
        function displayHistoryDetail(history) {
            if (!history) {
                showModalEmpty();
                return;
            }

            // 更新基本信息
            document.getElementById('modalProcessId').textContent = history.process_id;
            document.getElementById('modalComicTitle').textContent = history.title || '未命名漫画';
            document.getElementById('modalComicDescription').textContent = history.description || '无描述';
            document.getElementById('modalCreatedAt').textContent = new Date(history.created_at).toLocaleString();
            document.getElementById('modalScenesCount').textContent = history.comic_results ? history.comic_results.length : 0;

            // 更新标题
            document.getElementById('modalTitle').textContent = history.title || '漫画详情';

            // 显示图片内容
            const comicsGrid = document.getElementById('modalComicsGrid');
            comicsGrid.innerHTML = '';

            if (history.comic_results && history.comic_results.length > 0) {
                history.comic_results.forEach((scene, index) => {
                    const sceneCard = document.createElement('div');
                    sceneCard.className = 'modal-comic-card';

                    sceneCard.innerHTML = `
                        <div class="modal-comic-image">
                            <img src="${scene.url}"
                                 alt="场景 ${scene.scene_index}"
                                 style="width: 100%; height: 100%; object-fit: cover;"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=图片加载失败'">
                        </div>
                        <div class="modal-comic-info">
                            <div class="modal-comic-title">场景 ${scene.scene_index}</div>
                            <div class="modal-comic-description">
                                ${getSceneDescription(history.llm_result, scene.scene_index)}
                            </div>
                        </div>
                    `;

                    comicsGrid.appendChild(sceneCard);
                });
            } else {
                comicsGrid.innerHTML = `
                    <div class="modal-empty" style="grid-column: 1 / -1;">
                        <div style="font-size: 16px; margin-bottom: 10px;">没有生成图片</div>
                        <div style="color: #999; font-size: 14px;">该记录没有生成连环画图片</div>
                    </div>
                `;
            }

            showModalContent();
        }

        // 获取场景描述
        function getSceneDescription(llmResult, sceneIndex) {
            if (!llmResult || !llmResult.scenes_detail) {
                return '暂无描述';
            }

            const scenes = llmResult.scenes_detail;
            const index = parseInt(sceneIndex) - 1;

            if (index >= 0 && index < scenes.length) {
                const description = scenes[index];
                // 限制描述长度，避免显示过长
                return description.length > 150 ? description.substring(0, 150) + '...' : description;
            }

            return '暂无描述';
        }

        // 添加ESC键关闭模态框的支持
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('historyModal');
                if (!modal.classList.contains('hidden')) {
                    closeHistoryModal();
                }
            }
        });

        // 点击模态框背景关闭
        document.getElementById('historyModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHistoryModal();
            }
        });

        // WebSocket连接函数
        function connect() {
            if (isConnected) {
                log('已经连接到服务器', 'info');
                return;
            }

            if (!sessionToken) {
                log('请先登录', 'error');
                return;
            }

            updateStatus('正在连接...', 'connecting');
            log('正在连接到服务器...', 'info');

            try {
                const serverAddress = document.getElementById('serverAddress').value || 'http://10.201.202.108:5000';
                log(`尝试连接到服务器: ${serverAddress}`, 'info');

                // 创建新的Socket连接
                socket = io(serverAddress, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false,
                    auth: {
                        token: sessionToken
                    }
                });

                // 连接超时处理
                const connectionTimeout = setTimeout(() => {
                    if (!isConnected) {
                        log('连接超时，请检查服务器地址和网络连接', 'error');
                        updateStatus('连接超时', 'disconnected');
                        if (socket) socket.disconnect();
                    }
                }, 10000);

                socket.on('connect', () => {
                    clearTimeout(connectionTimeout);
                    isConnected = true;
                    updateStatus('已连接到服务器', 'connected');
                    log('成功连接到服务器', 'success');

                    // 发送认证信息
                    socket.emit('authenticate', { session_token: sessionToken });
                });

                socket.on('authentication_result', (data) => {
                    if (data.success) {
                        log('WebSocket认证成功', 'success');
                    } else {
                        log('WebSocket认证失败: ' + data.error, 'error');
                        disconnect();
                    }
                });

                socket.on('disconnect', (reason) => {
                    isConnected = false;
                    updateStatus('已断开连接: ' + reason, 'disconnected');
                    log('与服务器断开连接: ' + reason, 'error');
                    resetUI();
                });

                socket.on('connect_error', (error) => {
                    clearTimeout(connectionTimeout);
                    updateStatus('连接失败', 'disconnected');
                    log('连接错误: ' + error.message, 'error');
                    log('请检查服务器地址是否正确，以及网络连接是否正常', 'error');
                });

                // 文本处理完成事件
                socket.on('text_processing_complete', (data) => {
                    log('文本处理完成!', 'success');
                    currentProcessId = data.process_id;
                    log(`保存处理ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                socket.on('full_process_text_complete', (data) => {
                    log('完整流程 - 文本处理完成!', 'success');
                    currentProcessId = data.process_id;
                    log(`保存处理ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                // 图片生成进度事件
                socket.on('generation_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                socket.on('full_process_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                // 图片生成完成事件
                socket.on('comics_generation_complete', (data) => {
                    log('连环画生成完成!', 'success');
                    displayImagesResult(data);
                });

                socket.on('full_process_complete', (data) => {
                    log('完整流程处理完成!', 'success');
                    displayImagesResult(data);
                    // 生成完成后刷新历史记录
                    if (document.getElementById('historyTab').classList.contains('active')) {
                        loadHistory();
                    }
                });

                // 错误处理事件
                socket.on('process_error', (data) => {
                    log(`处理错误: ${data.error}`, 'error');
                    resetUI();
                });

                socket.on('generation_error', (data) => {
                    log(`生成错误: ${data.error}`, 'error');
                    hideProgressSection();
                });

                socket.on('full_process_error', (data) => {
                    log(`完整流程错误: ${data.error}`, 'error');
                    resetUI();
                });

            } catch (error) {
                updateStatus('连接失败', 'disconnected');
                log('连接异常: ' + error.message, 'error');
            }
        }

        // 断开WebSocket连接
        function disconnect() {
            if (socket) {
                socket.disconnect();
                isConnected = false;
                updateStatus('已手动断开连接', 'disconnected');
                log('已手动断开连接', 'info');
                resetUI();
            } else {
                log('没有活动的连接', 'info');
            }
        }

        // 修改完整流程处理函数，添加标题和描述
        function testFullProcess() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            if (!currentUser) {
                log('请先登录', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('请输入小说文本', 'error');
                return;
            }

            const title = document.getElementById('comicTitle').value;
            const description = document.getElementById('comicDescription').value;

            log('发送完整流程请求...', 'info');
            resetUI();
            socket.emit('full_process', {
                novel_text: novelText,
                title: title,
                description: description
            });
        }

        // 打开头像模态框
        function openAvatarModal() {
            console.log('打开头像设置');
            updateAvatarModal();
            document.getElementById('avatarModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 关闭头像模态框
        function closeAvatarModal() {
            console.log('关闭头像设置');
            document.getElementById('avatarModal').classList.add('hidden');
            document.body.style.overflow = '';
            resetAvatarUpload();
        }

        // 更新头像模态框内容
        function updateAvatarModal() {
            const currentAvatarDisplay = document.getElementById('currentAvatarDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');

            // 更新当前头像显示
            if (currentUser && currentUser.avatar) {
                const avatarUrl = `${getBaseUrl()}${currentUser.avatar}`;
                currentAvatarDisplay.src = avatarUrl;
                userAvatar.src = avatarUrl;
                removeAvatarBtn.style.display = 'block';
                console.log('更新模态框头像显示:', avatarUrl);
            } else {
                const defaultAvatar = `${getBaseUrl()}/api/avatar/default.png`;
                currentAvatarDisplay.src = defaultAvatar;
                userAvatar.src = defaultAvatar;
                removeAvatarBtn.style.display = 'none';
                console.log('更新模态框为默认头像:', defaultAvatar);
            }
        }

        // 确保 initAvatarUpload 函数存在
        function initAvatarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('avatarFileInput');

            if (!uploadArea || !fileInput) {
                console.error('找不到上传区域或文件输入元素');
                return;
            }

            // 点击上传区域
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // 文件选择变化
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // 拖拽功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });

            console.log('头像上传功能初始化完成');
        }

        // 处理文件选择
        function handleFileSelect(file) {
            console.log('选择文件:', file);

            // 检查文件类型和大小
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const maxSize = 2 * 1024 * 1024; // 2MB

            if (!allowedTypes.includes(file.type)) {
                log('请选择 JPG、PNG 或 GIF 格式的图片', 'error');
                return;
            }

            if (file.size > maxSize) {
                log('图片大小不能超过 2MB', 'error');
                return;
            }

            selectedAvatarFile = file;

            // 显示预览
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatarPreview').src = e.target.result;
                document.getElementById('uploadPreview').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('hidden');
            };
            reader.readAsDataURL(file);

            log('已选择图片，点击"确认上传"应用新头像', 'info');
        }

        // 取消上传
        function cancelUpload() {
            resetAvatarUpload();
            log('已取消图片选择', 'info');
        }

        // 重置上传状态
        function resetAvatarUpload() {
            selectedAvatarFile = null;
            document.getElementById('avatarFileInput').value = '';
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
        }

        // 添加调试函数
        function debugAvatarUpload() {
            console.log('=== 头像上传调试信息 ===');
            console.log('selectedAvatarFile:', selectedAvatarFile);
            console.log('sessionToken:', sessionToken ? '存在' : '不存在');
            console.log('currentUser:', currentUser);
            console.log('baseUrl:', getBaseUrl());
            console.log('========================');
        }

        // 上传头像
        async function uploadAvatar() {
            debugAvatarUpload(); // 添加这行

            if (!selectedAvatarFile) {
                log('请先选择图片', 'error');
                return;
            }

            try {
                log('正在上传头像...', 'info');

                const formData = new FormData();
                formData.append('avatar', selectedAvatarFile);

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: formData
                });

                // 添加响应状态检查
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('上传失败响应:', errorText);
                    throw new Error(`上传失败: ${response.status} ${response.statusText}`);
                }

                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('非JSON响应:', text.substring(0, 200));
                    throw new Error(`服务器返回了非JSON响应: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('上传响应数据:', data);

                if (data.success) {
                    log('头像上传成功！', 'success');

                    // 更新用户信息
                    await updateUserProfile();

                    // 重置上传状态
                    resetAvatarUpload();
                    closeAvatarModal();
                } else {
                    throw new Error(data.error || '上传失败');
                }
            } catch (error) {
                console.error('上传头像失败:', error);
                log('上传头像失败: ' + error.message, 'error');

                // 显示更详细的错误信息
                if (error.message.includes('401')) {
                    log('认证失败，请重新登录', 'error');
                } else if (error.message.includes('413')) {
                    log('文件太大，请选择小于2MB的图片', 'error');
                } else if (error.message.includes('400')) {
                    log('文件格式不支持，请选择JPG、PNG或GIF格式', 'error');
                }
            }
        }

        // 移除头像
        async function removeAvatar() {
            if (!confirm('确定要移除当前头像吗？')) {
                return;
            }

            try {
                log('正在移除头像...', 'info');

                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/avatar`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('头像移除成功！', 'success');

                    // 更新用户信息
                    await updateUserProfile();
                    closeAvatarModal();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '移除失败');
                }
            } catch (error) {
                console.error('移除头像失败:', error);
                log('移除头像失败: ' + error.message, 'error');
            }
        }

        // 更新用户信息（获取最新头像）
        async function updateUserProfile() {
            try {
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAvatarDisplay();
                    console.log('用户信息更新成功，头像:', currentUser.avatar);
                } else {
                    console.error('获取用户信息失败:', response.status);
                }
            } catch (error) {
                console.error('更新用户信息失败:', error);
            }
        }

        // 在 updateAvatarDisplay 函数中添加更多调试信息
        function updateAvatarDisplay() {
            const userAvatar = document.getElementById('userAvatar');
            console.log('updateAvatarDisplay 被调用，currentUser:', currentUser);

            if (currentUser && currentUser.avatar) {
                const avatarUrl = `${getBaseUrl()}${currentUser.avatar}`;
                userAvatar.src = avatarUrl;
                console.log('设置自定义头像 URL:', avatarUrl);

                // 添加加载成功和失败的监听器
                userAvatar.onload = function() {
                    console.log('头像加载成功:', avatarUrl);
                };
            } else {
                const defaultAvatar = `${getBaseUrl()}/api/avatar/default.png`;
                userAvatar.src = defaultAvatar;
                console.log('设置默认头像 URL:', defaultAvatar);
            }

            userAvatar.onerror = function() {
                console.warn('头像加载失败，使用默认头像');
                this.src = `${getBaseUrl()}/api/avatar/default.png`;
            };
        }

        // 在页面加载时初始化头像上传功能
        window.addEventListener('load', function() {
            console.log('页面加载完成，初始化头像功能');
            initAvatarUpload();

            // 如果已经登录，更新头像显示
            if (currentUser) {
                updateAvatarDisplay();
            }
        });

        // 原有的其他函数保持不变...
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;

            if (type === 'error') {
                logEntry.style.color = 'red';
                logEntry.style.borderLeftColor = '#dc3545';
            } else if (type === 'success') {
                logEntry.style.color = 'green';
                logEntry.style.borderLeftColor = '#28a745';
            } else if (type === 'warning') {
                logEntry.style.color = 'orange';
                logEntry.style.borderLeftColor = '#ffc107';
            }

            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateStatus(message, status) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${status}`;
        }

        function testProcessNovel() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('请输入小说文本', 'error');
                return;
            }

            log('发送小说处理请求...', 'info');
            resetUI();
            socket.emit('process_novel', { novel_text: novelText });
        }

        function generateComicsFromText() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            if (!currentProcessId) {
                log('请先完成文本处理', 'error');
                console.log(`当前处理ID: ${currentProcessId}`);
                return;
            }

            log(`开始生成连环画，处理ID: ${currentProcessId}`, 'info');
            showProgressSection();
            socket.emit('start_comics_generation', { process_id: currentProcessId });
        }

        function displayTextResult(data) {
            const textResultSection = document.getElementById('textResultSection');
            const textResultContent = document.getElementById('textResultContent');

            let html = `
                <div style="margin-bottom: 20px;">
                    <p><strong>处理ID:</strong> ${data.process_id}</p>
                    <p><strong>场景数量:</strong> ${data.scenes_count}</p>
                </div>
            `;

            if (data.character_consistency && Object.keys(data.character_consistency).length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <p><strong>角色设定:</strong></p>
                    <ul style="list-style: none; padding: 0;">`;
                for (const [name, desc] of Object.entries(data.character_consistency)) {
                    html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>${name}:</strong> ${desc}</li>`;
                }
                html += `</ul></div>`;
            }

            if (data.environment_consistency && Object.keys(data.environment_consistency).length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <p><strong>环境设定:</strong></p>
                    <ul style="list-style: none; padding: 0;">`;
                for (const [env, desc] of Object.entries(data.environment_consistency)) {
                    html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>${env}:</strong> ${desc}</li>`;
                }
                html += `</ul></div>`;
            }

            if (data.scenes_detail) {
                html += `<div><p><strong>场景详情:</strong></p>`;
                data.scenes_detail.forEach((scene, index) => {
                    html += `
                        <div class="scene-card">
                            <h4>场景 ${index + 1}</h4>
                            <p>${scene}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (data.scenes_preview) {
                html += `<div><p><strong>场景预览:</strong></p>`;
                data.scenes_preview.forEach(scene => {
                    html += `
                        <div class="scene-card">
                            <h4>场景 ${scene.scene_index}</h4>
                            <p>${scene.description}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            textResultContent.innerHTML = html;
            textResultSection.classList.remove('hidden');

            // 确保生成按钮可用
            document.getElementById('generateComicsBtn').disabled = false;
        }

        function displayImagesResult(data) {
            hideProgressSection();
            const imagesResultSection = document.getElementById('imagesResultSection');
            const imagesResultContent = document.getElementById('imagesResultContent');

            let html = `<p style="margin-bottom: 20px;"><strong>生成图片数量:</strong> ${data.total_scenes}</p>`;

            if (data.comic_results && data.comic_results.length > 0) {
                data.comic_results.forEach(scene => {
                    html += `
                        <div class="image-card">
                            <h4>场景 ${scene.scene_index}</h4>
                            <img src="${scene.url}" alt="场景 ${scene.scene_index}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=图片加载失败'">
                        </div>
                    `;
                });
            } else {
                html += `<p>没有生成图片</p>`;
            }

            imagesResultContent.innerHTML = html;
            imagesResultSection.classList.remove('hidden');
        }

        function updateProgress(current, total, message) {
            showProgressSection();
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = Math.round((current / total) * 100);

            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${message} (${current}/${total})`;

            log(`进度: ${message} (${current}/${total})`, 'info');
        }

        function showProgressSection() {
            document.getElementById('progressSection').classList.remove('hidden');
        }

        function hideProgressSection() {
            document.getElementById('progressSection').classList.add('hidden');
        }

        function resetUI() {
            document.getElementById('textResultSection').classList.add('hidden');
            document.getElementById('imagesResultSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            currentProcessId = null;
            document.getElementById('generateComicsBtn').disabled = false;
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                testFullProcess();
            }
            if (event.key === 'Escape') {
                disconnect();
            }
        });
    </script>
</body>
</html>