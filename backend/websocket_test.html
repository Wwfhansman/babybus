<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说转连环画系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .connect-btn {
            background-color: #007bff;
            color: white;
        }
        .disconnect-btn {
            background-color: #6c757d;
            color: white;
        }
        .primary-btn {
            background-color: #28a745;
            color: white;
        }
        .secondary-btn {
            background-color: #17a2b8;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-time {
            color: #6c757d;
            font-size: 0.8em;
        }
        .test-buttons {
            margin: 20px 0;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .text-result {
            background-color: #e9f7fe;
        }
        .images-result {
            background-color: #f0f9f0;
        }
        .scene-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .image-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            width: 300px;
            text-align: center;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>小说转连环画系统</h1>

        <div class="status disconnected" id="status">未连接</div>

        <div>
            <input type="text" id="serverAddress" value="http://10.201.202.108:5000" placeholder="服务器地址" style="width: 300px; padding: 8px; margin: 5px;">
            <button class="connect-btn" onclick="connect()">连接服务器</button>
            <button class="disconnect-btn" onclick="disconnect()">断开连接</button>
        </div>

        <div class="test-buttons">
            <h3>功能测试</h3>
            <textarea id="novelText" rows="8" cols="80" placeholder="请输入小说文本...">小明是一个勇敢的少年。一天，他在森林里遇到了一只受伤的小鹿。小明小心翼翼地接近小鹿，发现它的腿受伤了。他用自己的手帕为小鹿包扎伤口，然后帮助小鹿找到了它的妈妈。小鹿和它的妈妈都很感激小明，他们成为了好朋友。</textarea>
            <br><br>
            <button class="primary-btn" onclick="testFullProcess()">完整流程处理</button>
            <button class="secondary-btn" onclick="testProcessNovel()">仅处理文本</button>
        </div>

        <!-- 文本处理结果区域 -->
        <div id="textResultSection" class="section text-result hidden">
            <h3>文本处理结果</h3>
            <div id="textResultContent"></div>
            <button id="generateComicsBtn" class="primary-btn" onclick="generateComicsFromText()">生成连环画</button>
        </div>

        <!-- 图片生成进度区域 -->
        <div id="progressSection" class="section hidden">
            <h3>图片生成进度</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progressText">准备开始...</div>
        </div>

        <!-- 图片显示区域 -->
        <div id="imagesResultSection" class="section images-result hidden">
            <h3>生成的连环画</h3>
            <div id="imagesResultContent" class="image-container"></div>
        </div>

        <div class="log">
            <h3>系统日志</h3>
            <div id="logOutput"></div>
        </div>
    </div>

    <script>
        let socket;
        let isConnected = false;
        let currentProcessId = null;

        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;

            if (type === 'error') {
                logEntry.style.color = 'red';
            } else if (type === 'success') {
                logEntry.style.color = 'green';
            } else if (type === 'warning') {
                logEntry.style.color = 'orange';
            }

            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateStatus(message, status) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${status}`;
        }

        function connect() {
            if (isConnected) {
                log('已经连接到服务器', 'info');
                return;
            }

            updateStatus('正在连接...', 'connecting');
            log('正在连接到服务器...', 'info');

            try {
                const serverAddress = document.getElementById('serverAddress').value || 'http://10.201.202.108:5000';
                log(`尝试连接到服务器: ${serverAddress}`, 'info');
                socket = io(serverAddress, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false
                });

                // 连接超时处理
                setTimeout(() => {
                    if (!isConnected) {
                        log('连接超时，请检查服务器地址和网络连接', 'error');
                        updateStatus('连接超时', 'disconnected');
                        if (socket) socket.disconnect();
                    }
                }, 10000);

                socket.on('connect', () => {
                    isConnected = true;
                    updateStatus('已连接到服务器', 'connected');
                    log('成功连接到服务器', 'success');
                });

                socket.on('disconnect', (reason) => {
                    isConnected = false;
                    updateStatus('已断开连接: ' + reason, 'disconnected');
                    log('与服务器断开连接: ' + reason, 'error');
                    resetUI();
                });

                socket.on('connect_error', (error) => {
                    updateStatus('连接失败', 'disconnected');
                    log('连接错误: ' + error.message, 'error');
                    log('请检查服务器地址是否正确，以及网络连接是否正常', 'error');
                });

                // 文本处理完成事件
                socket.on('text_processing_complete', (data) => {
                    log('文本处理完成!', 'success');
                    currentProcessId = data.process_id; // 保存处理ID
                    log(`保存处理ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                socket.on('full_process_text_complete', (data) => {
                    log('完整流程 - 文本处理完成!', 'success');
                    currentProcessId = data.process_id; // 保存处理ID
                    log(`保存处理ID: ${currentProcessId}`, 'info');
                    displayTextResult(data);
                });

                // 图片生成进度事件
                socket.on('generation_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                socket.on('full_process_progress', (data) => {
                    updateProgress(data.step, data.total, data.message);
                });

                // 图片生成完成事件
                socket.on('comics_generation_complete', (data) => {
                    log('连环画生成完成!', 'success');
                    displayImagesResult(data);
                });

                socket.on('full_process_complete', (data) => {
                    log('完整流程处理完成!', 'success');
                    displayImagesResult(data);
                });

                // 错误处理事件
                socket.on('process_error', (data) => {
                    log(`处理错误: ${data.error}`, 'error');
                    resetUI();
                });

                socket.on('generation_error', (data) => {
                    log(`生成错误: ${data.error}`, 'error');
                    hideProgressSection();
                });

                socket.on('full_process_error', (data) => {
                    log(`完整流程错误: ${data.error}`, 'error');
                    resetUI();
                });

            } catch (error) {
                updateStatus('连接失败', 'disconnected');
                log('连接异常: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                isConnected = false;
                updateStatus('已手动断开连接', 'disconnected');
                log('已手动断开连接', 'info');
                resetUI();
            } else {
                log('没有活动的连接', 'info');
            }
        }

        function testProcessNovel() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('请输入小说文本', 'error');
                return;
            }

            log('发送小说处理请求...', 'info');
            resetUI();
            socket.emit('process_novel', { novel_text: novelText });
        }

        function testFullProcess() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            const novelText = document.getElementById('novelText').value;
            if (!novelText.trim()) {
                log('请输入小说文本', 'error');
                return;
            }

            log('发送完整流程请求...', 'info');
            resetUI();
            socket.emit('full_process', { novel_text: novelText });
        }

        function generateComicsFromText() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }

            if (!currentProcessId) {
                log('请先完成文本处理', 'error');
                log(`当前处理ID: ${currentProcessId}`, 'error');
                return;
            }

            log(`开始生成连环画，处理ID: ${currentProcessId}`, 'info');
            showProgressSection();
            socket.emit('start_comics_generation', { process_id: currentProcessId });
        }

        function displayTextResult(data) {
            const textResultSection = document.getElementById('textResultSection');
            const textResultContent = document.getElementById('textResultContent');

            let html = `
                <p><strong>处理ID:</strong> ${data.process_id}</p>
                <p><strong>场景数量:</strong> ${data.scenes_count}</p>
            `;

            if (data.character_consistency && Object.keys(data.character_consistency).length > 0) {
                html += `<p><strong>角色设定:</strong></p><ul>`;
                for (const [name, desc] of Object.entries(data.character_consistency)) {
                    html += `<li><strong>${name}:</strong> ${desc}</li>`;
                }
                html += `</ul>`;
            }

            if (data.environment_consistency && Object.keys(data.environment_consistency).length > 0) {
                html += `<p><strong>环境设定:</strong></p><ul>`;
                for (const [env, desc] of Object.entries(data.environment_consistency)) {
                    html += `<li><strong>${env}:</strong> ${desc}</li>`;
                }
                html += `</ul>`;
            }

            if (data.scenes_detail) {
                html += `<p><strong>场景详情:</strong></p>`;
                data.scenes_detail.forEach((scene, index) => {
                    html += `
                        <div class="scene-card">
                            <h4>场景 ${index + 1}</h4>
                            <p>${scene}</p>
                        </div>
                    `;
                });
            } else if (data.scenes_preview) {
                html += `<p><strong>场景预览:</strong></p>`;
                data.scenes_preview.forEach(scene => {
                    html += `
                        <div class="scene-card">
                            <h4>场景 ${scene.scene_index}</h4>
                            <p>${scene.description}</p>
                        </div>
                    `;
                });
            }

            textResultContent.innerHTML = html;
            textResultSection.classList.remove('hidden');

            // 确保生成按钮可用
            document.getElementById('generateComicsBtn').disabled = false;
        }

        function displayImagesResult(data) {
            hideProgressSection();
            const imagesResultSection = document.getElementById('imagesResultSection');
            const imagesResultContent = document.getElementById('imagesResultContent');

            let html = `<p><strong>生成图片数量:</strong> ${data.total_scenes}</p>`;

            if (data.comic_results && data.comic_results.length > 0) {
                data.comic_results.forEach(scene => {
                    html += `
                        <div class="image-card">
                            <h4>场景 ${scene.scene_index}</h4>
                            <img src="${scene.url}" alt="场景 ${scene.scene_index}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=图片加载失败'">
                        </div>
                    `;
                });
            } else {
                html += `<p>没有生成图片</p>`;
            }

            imagesResultContent.innerHTML = html;
            imagesResultSection.classList.remove('hidden');
        }

        function updateProgress(current, total, message) {
            showProgressSection();
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = Math.round((current / total) * 100);

            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${message} (${current}/${total})`;

            log(`进度: ${message} (${current}/${total})`, 'info');
        }

        function showProgressSection() {
            document.getElementById('progressSection').classList.remove('hidden');
        }

        function hideProgressSection() {
            document.getElementById('progressSection').classList.add('hidden');
        }

        function resetUI() {
            document.getElementById('textResultSection').classList.add('hidden');
            document.getElementById('imagesResultSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            currentProcessId = null;
            document.getElementById('generateComicsBtn').disabled = false;
        }

        // 页面加载完成
        window.addEventListener('load', function() {
            log('页面加载完成', 'info');
            log('请确保服务器地址正确，且在同一网络中可以访问该服务器', 'info');
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                testFullProcess();
            }
            if (event.key === 'Escape') {
                disconnect();
            }
        });
    </script>
</body>
</html>